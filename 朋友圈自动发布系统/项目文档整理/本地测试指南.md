# 本地测试指南

[← 返回README](./README.md)

---

## 📋 目录

- [为什么需要本地测试](#-为什么需要本地测试)
- [本地开发环境配置](#-本地开发环境配置)
- [Puppeteer有头模式配置](#-puppeteer有头模式配置)
- [本地测试流程](#-本地测试流程)
- [测试完成后部署](#-测试完成后部署)
- [最佳实践](#-最佳实践)

---

## 🎯 为什么需要本地测试

### ❌ 直接在服务器测试的问题

1. **影响现有功能** - 频繁重启PM2服务会导致正在运行的任务中断
2. **无法看到操作过程** - 服务器使用无头模式,看不到Puppeteer的浏览器操作
3. **调试困难** - 只能通过日志排查问题,效率低
4. **风险高** - 未经测试的代码可能导致生产环境故障

### ✅ 本地测试的优势

1. **可视化调试** - 有头模式可以看到浏览器的每一步操作
2. **快速迭代** - 修改代码后立即测试,无需部署
3. **不影响生产** - 本地测试不会影响服务器上的功能
4. **降低风险** - 充分测试后再部署,确保功能正常

---

## 🚀 本地开发环境配置

### 环境要求

- **Node.js**: 20.19.5+ (推荐使用nvm管理)
- **Pnpm**: 8.0+ (前端依赖管理)
- **Docker**: 最新版本 (用于we-mp-rss,可选)
- **操作系统**: macOS / Linux / Windows

### 安装步骤

#### 1. 安装Node.js

```bash
# 使用nvm安装(推荐)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc  # 或 ~/.zshrc

nvm install 20.19.5
nvm use 20.19.5
nvm alias default 20.19.5

# 验证安装
node -v  # 应该显示 v20.19.5
npm -v
```

#### 2. 安装Pnpm

```bash
npm install -g pnpm

# 验证安装
pnpm -v
```

#### 3. 克隆项目(如果还没有)

```bash
cd ~/Desktop/编程专用
git pull  # 如果已经克隆,拉取最新代码
```

#### 4. 配置后端环境变量

在 `朋友圈自动发布系统/pyq-backend` 目录创建 `.env` 文件:

```bash
cd 朋友圈自动发布系统/pyq-backend
nano .env
```

复制以下内容(使用生产环境的配置):

```env
# ==================== 数据库配置 ====================
SUPABASE_URL=https://upcsdbcpmzpywvykiqtu.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwY3NkYmNwbXpweXd2eWtpcXR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk2NzI5NzQsImV4cCI6MjA0NTI0ODk3NH0.Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwY3NkYmNwbXpweXd2eWtpcXR1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcyOTY3Mjk3NCwiZXhwIjoyMDQ1MjQ4OTc0fQ.Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks_Ks

# ==================== JWT配置 ====================
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# ==================== Coze API配置 ====================
COZE_API_KEY=sat_IypG3mLLmm4m1qaRx6qK4E0HpKN6z910uZlEuU9xzLKRja92fpeEVH4EcKsM0y9D
COZE_WORKFLOW_ID=7564955686342918154

# ==================== we-mp-rss配置 ====================
WE_MP_RSS_URL=http://124.223.35.102:8001
WE_MP_RSS_USERNAME=admin
WE_MP_RSS_PASSWORD=admin@123

# ==================== 服务器配置 ====================
PORT=3000
NODE_ENV=development

# ==================== Puppeteer配置 (重要!) ====================
# 设置为false显示浏览器窗口,方便调试
PUPPETEER_HEADLESS=false
```

**⚠️ 重要**: 最后一行 `PUPPETEER_HEADLESS=false` 是关键,设置为`false`可以看到浏览器操作!

#### 5. 安装后端依赖

```bash
cd 朋友圈自动发布系统/pyq-backend
npm install
```

#### 6. 启动后端服务

```bash
npm run start:dev
```

看到以下日志说明启动成功:
```
[Nest] 12345  - 2025/11/15 10:00:00     LOG [NestApplication] Nest application successfully started
[Nest] 12345  - 2025/11/15 10:00:00     LOG [Bootstrap] 应用已启动: http://localhost:3000
```

#### 7. 安装前端依赖(可选)

如果需要测试前端:

```bash
cd 朋友圈自动发布系统/pyq-frontend-vben
pnpm install
pnpm dev:antd
```

访问 http://localhost:5666 查看前端页面

---

## 🎨 Puppeteer有头模式配置

### 方法一: 环境变量配置(推荐)

在 `.env` 文件中设置:

```env
# 显示浏览器窗口
PUPPETEER_HEADLESS=false
```

**优点**: 
- 不需要修改代码
- 可以随时切换有头/无头模式
- 生产环境设置为`true`,本地设置为`false`

### 方法二: 使用测试脚本

项目中已经有多个测试脚本,都使用有头模式:

```bash
# 测试微信好友同步
node 朋友圈自动发布系统/test-wechat-sync.js

# 测试视频号素材对话框
node 朋友圈自动发布系统/test-video-material-dialog.js

# 测试堆雪球点击
node 朋友圈自动发布系统/test-duixueqiu-click.js
```

**优点**:
- 独立测试脚本,不影响主服务
- 可以添加更多调试日志
- 可以设置`slowMo`参数减慢操作速度

### 测试脚本示例

创建自己的测试脚本 `test-my-feature.js`:

```javascript
const puppeteer = require('puppeteer');

async function test() {
  console.log('🚀 启动浏览器...');
  
  const browser = await puppeteer.launch({
    headless: false,  // 显示浏览器窗口
    slowMo: 300,      // 每个操作延迟300ms,便于观察
    devtools: true,   // 自动打开开发者工具
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--window-size=1920,1080',
    ],
  });

  const page = await browser.newPage();
  await page.setViewport({ width: 1920, height: 1080 });

  // 你的测试代码...
  await page.goto('https://dxqscrm.duixueqiu.cn/admin/login');
  
  // 测试完成后不要自动关闭浏览器,方便查看
  console.log('✅ 测试完成,浏览器保持打开状态');
  console.log('按Ctrl+C退出');
}

test().catch(console.error);
```

---

## 🧪 本地测试流程

### 标准测试流程

#### 1. 启动本地后端服务

```bash
cd 朋友圈自动发布系统/pyq-backend
npm run start:dev
```

#### 2. 确认环境变量

```bash
# 查看环境变量
cat .env | grep PUPPETEER_HEADLESS

# 应该显示: PUPPETEER_HEADLESS=false
```

#### 3. 测试Puppeteer功能

**方法A: 通过前端页面测试**

1. 启动前端: `cd pyq-frontend-vben && pnpm dev:antd`
2. 访问 http://localhost:5666
3. 登录系统
4. 进入相应功能页面(Script 1/2/4)
5. 点击执行按钮
6. **观察浏览器窗口** - 可以看到Puppeteer的每一步操作!

**方法B: 使用测试脚本**

```bash
# 测试微信好友同步
node test-wechat-sync.js

# 测试视频号素材
node test-video-material-dialog.js
```

#### 4. 观察和调试

- **浏览器窗口**: 可以看到Puppeteer的操作过程
- **开发者工具**: 查看页面元素和网络请求
- **后端日志**: 查看详细的执行日志
- **截图**: 关键步骤会自动截图保存

#### 5. 修改和重测

```bash
# 修改代码后,重启后端服务
# 按 Ctrl+C 停止服务
npm run start:dev  # 重新启动

# 或使用nodemon自动重启
npm install -g nodemon
nodemon --watch src --exec "npm run start:dev"
```

---

## 🚀 测试完成后部署

### 部署前检查清单

- [ ] 本地测试所有功能正常
- [ ] 浏览器操作流程正确
- [ ] 没有JavaScript错误
- [ ] 日志输出正常
- [ ] 已提交代码到Git

### 部署步骤

#### 1. 修改环境变量为生产模式

**重要**: 部署到服务器前,确保使用无头模式!

本地 `.env` 文件保持 `PUPPETEER_HEADLESS=false`

服务器 `.env` 文件使用 `PUPPETEER_HEADLESS=true` (或不设置,默认为true)

#### 2. 提交代码

```bash
cd 朋友圈自动发布系统
git add .
git commit -m "feat: 添加XXX功能"
git push
```

#### 3. 部署到服务器

**方法A: 使用部署脚本(推荐)**

```bash
cd 朋友圈自动发布系统
./deploy-update.sh
```

**方法B: 手动部署**

```bash
# 1. 本地构建
cd pyq-backend
npm run build

# 2. 上传到服务器
scp -r dist root@124.223.35.102:/www/wwwroot/pyq-backend/pyq-backend/

# 3. 重启服务
ssh root@124.223.35.102 'cd /www/wwwroot/pyq-backend/pyq-backend && pm2 restart pyq-backend'

# 4. 查看日志
ssh root@124.223.35.102 'pm2 logs pyq-backend --lines 50'
```

#### 4. 验证部署

```bash
# 查看服务状态
ssh root@124.223.35.102 'pm2 list'

# 查看日志
ssh root@124.223.35.102 'pm2 logs pyq-backend --lines 100'

# 测试API
curl https://autochat.lfdhk.com/api/health
```

---

## 💡 最佳实践

### 开发流程建议

```
1. 本地开发 (有头模式)
   ↓
2. 本地测试 (观察浏览器操作)
   ↓
3. 修复问题 (快速迭代)
   ↓
4. 充分测试 (确保功能正常)
   ↓
5. 提交代码 (Git版本管理)
   ↓
6. 部署到服务器 (无头模式)
   ↓
7. 验证生产环境 (查看日志)
```

### 调试技巧

#### 1. 使用slowMo参数

```javascript
const browser = await puppeteer.launch({
  headless: false,
  slowMo: 500,  // 每个操作延迟500ms,便于观察
});
```

#### 2. 自动打开开发者工具

```javascript
const browser = await puppeteer.launch({
  headless: false,
  devtools: true,  // 自动打开开发者工具
});
```

#### 3. 添加详细日志

```typescript
this.logger.log('🖱️  [步骤1] 点击登录按钮...');
await page.click('button.login');
this.logger.log('✅ [步骤1] 登录按钮已点击');
```

#### 4. 关键步骤截图

```typescript
await page.screenshot({ 
  path: `debug_step_${Date.now()}.png`, 
  fullPage: true 
});
```

### 常见问题

#### Q1: 浏览器窗口一闪而过?

**原因**: 脚本执行完成后自动关闭浏览器

**解决方案**:
```javascript
// 测试脚本最后添加
console.log('✅ 测试完成,浏览器保持打开');
console.log('按Ctrl+C退出');
await new Promise(() => {}); // 永久等待
```

#### Q2: 本地测试正常,服务器失败?

**可能原因**:
- 服务器缺少中文字体(影响截图,不影响功能)
- 环境变量配置不同
- 网络环境差异

**解决方案**:
- 检查服务器 `.env` 文件
- 查看PM2日志: `pm2 logs pyq-backend`
- 对比本地和服务器的环境变量

#### Q3: 如何在服务器临时使用有头模式?

**不推荐**: 服务器通常没有图形界面

**替代方案**:
- 使用VNC连接服务器
- 或使用Xvfb虚拟显示
- 或通过截图调试

---

## 🔗 相关文档

- [部署与配置指南](./部署与配置指南.md) - 完整部署流程
- [堆雪球自动化操作指南](./堆雪球自动化操作指南.md) - Puppeteer技术要点
- [常见问题与解决方案](./常见问题与解决方案.md) - 问题排查
- [危险操作警告](./危险操作警告.md) - 禁止的操作

---

[← 返回README](./README.md)

---

**最后更新**: 2025-11-15
**维护者**: 小牛马

