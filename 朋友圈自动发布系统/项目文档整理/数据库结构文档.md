# æ•°æ®åº“æ–‡æ¡£

> **âš ï¸ é‡è¦è­¦å‘Š**: ä¿®æ”¹æ•°æ®åº“ç»“æ„å‰å¿…é¡»é˜…è¯»æœ¬æ–‡æ¡£å’Œ[å±é™©æ“ä½œè­¦å‘Š](./å±é™©æ“ä½œè­¦å‘Š.md)

**æ•°æ®åº“ç±»å‹**: PostgreSQL 15+
**æ‰˜ç®¡å¹³å°**: Supabase
**æœ€åæ›´æ–°**: 2025-11-12

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“æ¦‚è¿°](#æ•°æ®åº“æ¦‚è¿°)
- [æ ¸å¿ƒçº¦æŸå’Œæ³¨æ„äº‹é¡¹](#æ ¸å¿ƒçº¦æŸå’Œæ³¨æ„äº‹é¡¹)
- [æ•°æ®åº“è¡¨æ¸…å•](#æ•°æ®åº“è¡¨æ¸…å•)
- [ERå›¾(å¯è§†åŒ–å…³ç³»)](#erå›¾å¯è§†åŒ–å…³ç³»)
- [è¡¨ç»“æ„è¯¦ç»†è¯´æ˜](#è¡¨ç»“æ„è¯¦ç»†è¯´æ˜)
- [Supabase Storageé…ç½®](#supabase-storageé…ç½®)
- [ç´¢å¼•å’Œè§¦å‘å™¨](#ç´¢å¼•å’Œè§¦å‘å™¨)
- [æ•°æ®åº“è¿ç§»å†å²](#æ•°æ®åº“è¿ç§»å†å²)

---

## ğŸ“Š æ•°æ®åº“æ¦‚è¿°

### æ ¸å¿ƒç»„ä»¶

æœ¬é¡¹ç›®ä½¿ç”¨Supabaseä½œä¸ºæ•°æ®åº“å¹³å°,åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶:

1. **PostgreSQLæ•°æ®åº“** - å­˜å‚¨ç»“æ„åŒ–æ•°æ®
   - 9ä¸ªæ ¸å¿ƒè¡¨
   - UUIDä¸»é”®è®¾è®¡
   - å®Œå–„çš„å¤–é”®çº¦æŸ
   - è‡ªåŠ¨æ—¶é—´æˆ³

2. **Supabase Storage** - å­˜å‚¨æ–‡ä»¶(å›¾ç‰‡)
   - `follow-circle-images` Bucket
   - å…¬å¼€è®¿é—®ç­–ç•¥
   - è‡ªåŠ¨æ¸…ç†æœºåˆ¶
   - 1GBå…è´¹é¢åº¦

### æŠ€æœ¯ç‰¹ç‚¹

- âœ… **ç±»å‹å®‰å…¨** - ä½¿ç”¨UUIDä¸»é”®,é¿å…IDå†²çª
- âœ… **å…³ç³»å®Œæ•´** - å®Œå–„çš„å¤–é”®çº¦æŸå’Œçº§è”åˆ é™¤
- âœ… **æ€§èƒ½ä¼˜åŒ–** - åˆç†çš„ç´¢å¼•è®¾è®¡
- âœ… **æ•°æ®å®‰å…¨** - RLSç­–ç•¥ä¿æŠ¤
- âœ… **è‡ªåŠ¨åŒ–** - å®šæ—¶æ¸…ç†è¿‡æœŸæ•°æ®

---

## âš ï¸ æ ¸å¿ƒçº¦æŸå’Œæ³¨æ„äº‹é¡¹

### ğŸš¨ ç»å¯¹ç¦æ­¢çš„æ“ä½œ

1. **ç¦æ­¢ä¿®æ”¹ä¸»é”®ç±»å‹**
   - `users.id` æ˜¯ `UUID` ç±»å‹,**ç»å¯¹ä¸èƒ½æ”¹ä¸ºå…¶ä»–ç±»å‹**
   - æ‰€æœ‰å…³è”è¡¨çš„ `user_id` **å¿…é¡»æ˜¯ `UUID` ç±»å‹**
   - ä¿®æ”¹ä¼šå¯¼è‡´æ‰€æœ‰å…³è”è¡¨çš„å¤–é”®å¤±æ•ˆ

2. **ç¦æ­¢åˆ é™¤è¡¨**
   - åˆ é™¤è¡¨ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±
   - åˆ é™¤è¡¨ä¼šå¯¼è‡´å…³è”è¡¨çš„å¤–é”®å¤±æ•ˆ
   - **å¦‚æœå¿…é¡»åˆ é™¤,å¿…é¡»å…ˆå¤‡ä»½æ•°æ®åº“**

3. **ç¦æ­¢ä¿®æ”¹å­—æ®µç±»å‹**
   - ä¿®æ”¹å­—æ®µç±»å‹å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
   - ä¿®æ”¹å­—æ®µç±»å‹å¯èƒ½å¯¼è‡´åº”ç”¨ç¨‹åºæŠ¥é”™
   - **å¦‚æœå¿…é¡»ä¿®æ”¹,å¿…é¡»å…ˆåˆ›å»ºè¿ç§»æ–‡ä»¶å¹¶æµ‹è¯•**

4. **ç¦æ­¢åˆ é™¤è¿ç§»æ–‡ä»¶**
   - è¿ç§»æ–‡ä»¶æ˜¯æ•°æ®åº“å˜æ›´çš„å†å²è®°å½•
   - åˆ é™¤ä¼šå¯¼è‡´æ— æ³•è¿½æº¯å˜æ›´
   - **ç»å¯¹ä¸è¦åˆ é™¤ `migrations/` ç›®å½•ä¸‹çš„æ–‡ä»¶**

### âœ… å®‰å…¨çš„æ“ä½œ

1. **æŸ¥è¯¢æ•°æ®** - éšæ—¶å¯ä»¥æŸ¥è¯¢
2. **æ’å…¥æ•°æ®** - æ³¨æ„å­—æ®µç±»å‹å’Œçº¦æŸ
3. **æ›´æ–°æ•°æ®** - æ³¨æ„ä¸è¦ä¿®æ”¹å…³é”®å­—æ®µ
4. **åˆ›å»ºç´¢å¼•** - å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### ğŸ“ ä¿®æ”¹æ•°æ®åº“çš„æ­£ç¡®æµç¨‹

1. **åˆ›å»ºè¿ç§»æ–‡ä»¶** - åœ¨ `migrations/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„SQLæ–‡ä»¶
2. **åœ¨æœ¬åœ°æµ‹è¯•** - å…ˆåœ¨æœ¬åœ°æ•°æ®åº“æµ‹è¯•è¿ç§»
3. **å¤‡ä»½æ•°æ®åº“** - åœ¨Supabaseåå°åˆ›å»ºå¤‡ä»½
4. **æ‰§è¡Œè¿ç§»** - åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»
5. **éªŒè¯åŠŸèƒ½** - æµ‹è¯•æ‰€æœ‰ç›¸å…³åŠŸèƒ½æ˜¯å¦æ­£å¸¸
6. **å‡†å¤‡å›æ»š** - å¦‚æœå‡ºé—®é¢˜,ç«‹å³å›æ»š

---

## ğŸ“Š æ•°æ®åº“è¡¨æ¸…å•

### æ ¸å¿ƒè¡¨ (13ä¸ª)

| åºå· | è¡¨å | ç”¨é€” | ä¸»é”®ç±»å‹ | å…³è”è¡¨ |
|------|------|------|---------|--------|
| 1 | `users` | ç”¨æˆ·è¡¨ | UUID | æ‰€æœ‰è¡¨ |
| 2 | `wechat_articles` | å…¬ä¼—å·æ–‡ç« è¡¨ | UUID | rewrite_history, publish_tasks |
| 3 | `monitor_config` | ç›‘æ§é…ç½®è¡¨ | UUID | - |
| 4 | `rewrite_history` | è½¬å†™å†å²è¡¨ | UUID | users, wechat_articles |
| 5 | `publish_tasks` | å‘å¸ƒä»»åŠ¡è¡¨ | UUID | users, rewrite_history |
| 6 | `follow_circle_tasks` | è·Ÿåœˆä»»åŠ¡è¡¨ | SERIAL | users |
| 7 | `delete_circle_tasks` | åˆ é™¤ä»»åŠ¡è¡¨ | SERIAL | - |
| 8 | `duixueqiu_accounts` | å †é›ªçƒè´¦å·è¡¨ | SERIAL | users |
| 9 | `duixueqiu_video_materials` | è§†é¢‘å·ç´ æè¡¨ | SERIAL | users |
| 10 | `duixueqiu_link_materials` | é“¾æ¥ç´ æè¡¨ | SERIAL | users |
| 11 | `duixueqiu_friends` | å †é›ªçƒå¥½å‹è¡¨ | BIGSERIAL | users |
| 12 | `wechat_subscriptions` | å…¬ä¼—å·è®¢é˜…è¡¨ | BIGSERIAL | users |
| 13 | `message_send_history` | æ¶ˆæ¯å‘é€å†å²è¡¨ | BIGSERIAL | users, duixueqiu_friends |

### è¡¨åˆ†ç±»

**ç”¨æˆ·ç›¸å…³**:
- `users` - ç”¨æˆ·åŸºç¡€ä¿¡æ¯

**å…¬ä¼—å·ç›‘æ§ç›¸å…³**:
- `wechat_articles` - å…¬ä¼—å·æ–‡ç« 
- `monitor_config` - ç›‘æ§é…ç½®
- `rewrite_history` - è½¬å†™å†å²

**å‘å¸ƒç›¸å…³**:
- `publish_tasks` - å‘å¸ƒä»»åŠ¡
- `follow_circle_tasks` - è·Ÿåœˆä»»åŠ¡
- `delete_circle_tasks` - åˆ é™¤ä»»åŠ¡

**å †é›ªçƒç›¸å…³**:
- `duixueqiu_accounts` - å †é›ªçƒè´¦å·
- `duixueqiu_video_materials` - è§†é¢‘å·ç´ æ
- `duixueqiu_link_materials` - é“¾æ¥ç´ æ
- `duixueqiu_friends` - å †é›ªçƒå¥½å‹åˆ—è¡¨

**å¾®ä¿¡å¥½å‹è§¦è¾¾ç›¸å…³**:
- `message_send_history` - æ¶ˆæ¯å‘é€å†å²(é˜²é‡å¤å‘é€)

**å…¬ä¼—å·è®¢é˜…ç›¸å…³**:
- `wechat_subscriptions` - å…¬ä¼—å·è®¢é˜…é…ç½®

---

## ğŸ—ºï¸ ERå›¾(å¯è§†åŒ–å…³ç³»)

### å®Œæ•´ERå›¾

```mermaid
erDiagram
    users ||--o{ rewrite_history : "åˆ›å»º"
    users ||--o{ publish_tasks : "åˆ›å»º"
    users ||--o{ follow_circle_tasks : "åˆ›å»º"
    users ||--o{ duixueqiu_accounts : "æ‹¥æœ‰"
    users ||--o{ duixueqiu_video_materials : "æ‹¥æœ‰"

    wechat_articles ||--o{ rewrite_history : "è¢«è½¬å†™"

    rewrite_history ||--o{ publish_tasks : "ç”Ÿæˆ"

    users {
        UUID id PK "ç”¨æˆ·ID"
        VARCHAR username UK "ç™»å½•è´¦å·"
        VARCHAR name "ç”¨æˆ·å§“å"
        VARCHAR password "åŠ å¯†å¯†ç "
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    wechat_articles {
        UUID id PK "æ–‡ç« ID"
        VARCHAR title "æ–‡ç« æ ‡é¢˜"
        TEXT content "æ–‡ç« æ­£æ–‡"
        TEXT[] images "å›¾ç‰‡URLæ•°ç»„"
        TIMESTAMP publish_time "å‘å¸ƒæ—¶é—´"
        VARCHAR author "ä½œè€…"
        VARCHAR url "åŸæ–‡é“¾æ¥"
        VARCHAR account_name "å…¬ä¼—å·åç§°"
        VARCHAR account_id "å…¬ä¼—å·ID"
        VARCHAR status "å¤„ç†çŠ¶æ€"
        TEXT rewritten_content "æ”¹å†™åå†…å®¹"
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    monitor_config {
        UUID id PK "é…ç½®ID"
        VARCHAR config_key UK "é…ç½®é”®å"
        TEXT config_value "é…ç½®å€¼"
        TEXT description "é…ç½®è¯´æ˜"
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    rewrite_history {
        UUID id PK "è½¬å†™è®°å½•ID"
        UUID user_id FK "ç”¨æˆ·ID"
        UUID article_id FK "æ–‡ç« ID"
        TEXT original_content "åŸå§‹å†…å®¹"
        TEXT[] original_images "åŸå§‹å›¾ç‰‡"
        TEXT rewritten_content "è½¬å†™åå†…å®¹"
        TEXT[] selected_images "é€‰æ‹©çš„å›¾ç‰‡"
        VARCHAR coze_workflow_id "Cozeå·¥ä½œæµID"
        VARCHAR status "è½¬å†™çŠ¶æ€"
        TEXT error_message "é”™è¯¯ä¿¡æ¯"
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    publish_tasks {
        UUID id PK "ä»»åŠ¡ID"
        UUID user_id FK "ç”¨æˆ·ID"
        UUID rewrite_id FK "è½¬å†™è®°å½•ID"
        VARCHAR task_title "ä»»åŠ¡æ ‡é¢˜"
        TEXT content "å‘å¸ƒå†…å®¹"
        TEXT[] images "å›¾ç‰‡URLæ•°ç»„"
        VARCHAR wechat_account "å¾®ä¿¡è´¦å·"
        TIMESTAMP publish_time "å‘å¸ƒæ—¶é—´"
        BOOLEAN is_immediate "æ˜¯å¦ç«‹å³å‘å¸ƒ"
        INTEGER random_delay_minutes "éšæœºå»¶è¿Ÿåˆ†é’Ÿ"
        VARCHAR status "ä»»åŠ¡çŠ¶æ€"
        VARCHAR duixueqiu_task_id "å †é›ªçƒä»»åŠ¡ID"
        TEXT error_message "é”™è¯¯ä¿¡æ¯"
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    follow_circle_tasks {
        SERIAL id PK "ä»»åŠ¡ID"
        UUID user_id FK "ç”¨æˆ·ID"
        VARCHAR task_group_id "ä»»åŠ¡ç»„ID"
        INT circle_index "ç¬¬å‡ æ¡è·Ÿåœˆ"
        TEXT content "æœ‹å‹åœˆå†…å®¹"
        JSONB images "å›¾ç‰‡åˆ—è¡¨JSON"
        TIMESTAMP publish_time "å‘å¸ƒæ—¶é—´"
        BOOLEAN delete_previous "æ˜¯å¦åˆ é™¤ä¸Šä¸€æ¡"
        VARCHAR previous_title "ä¸Šä¸€æ¡æ ‡é¢˜"
        VARCHAR status "ä»»åŠ¡çŠ¶æ€"
        TEXT error_message "é”™è¯¯ä¿¡æ¯"
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    delete_circle_tasks {
        SERIAL id PK "ä»»åŠ¡ID"
        VARCHAR task_group_id "ä»»åŠ¡ç»„ID"
        INTEGER circle_index "ç¬¬å‡ æ¡æœ‹å‹åœˆ"
        VARCHAR delete_title "è¦åˆ é™¤çš„æ ‡é¢˜"
        TEXT delete_content "æœ‹å‹åœˆå†…å®¹"
        TIMESTAMP delete_time "åˆ é™¤æ—¶é—´"
        VARCHAR status "ä»»åŠ¡çŠ¶æ€"
        TEXT error_message "é”™è¯¯ä¿¡æ¯"
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    duixueqiu_accounts {
        SERIAL id PK "è´¦å·ID"
        UUID user_id FK "ç”¨æˆ·ID"
        VARCHAR account_name "è´¦å·åç§°"
        VARCHAR username "å †é›ªçƒç”¨æˆ·å"
        TEXT password "å †é›ªçƒå¯†ç "
        BOOLEAN is_default "æ˜¯å¦é»˜è®¤è´¦å·"
        VARCHAR status "è´¦å·çŠ¶æ€"
        TIMESTAMP created_at "åˆ›å»ºæ—¶é—´"
        TIMESTAMP updated_at "æ›´æ–°æ—¶é—´"
    }

    duixueqiu_video_materials {
        SERIAL id PK "ç´ æID"
        UUID user_id FK "ç”¨æˆ·ID"
        VARCHAR author_name "å‘å¸ƒè€…åç§°"
        TEXT content_desc "å†…å®¹æè¿°"
        INT material_index "ç´¢å¼•ä½ç½®"
        INT page_number "æ‰€åœ¨é¡µç "
        VARCHAR group_name "ç´ æåˆ†ç»„"
        TIMESTAMP sync_time "åŒæ­¥æ—¶é—´"
        TIMESTAMP create_time "åˆ›å»ºæ—¶é—´"
    }
```

---

### æ ¸å¿ƒè¡¨å…³ç³»

#### ç”¨æˆ·ä¸­å¿ƒå…³ç³»

```mermaid
graph TD
    A[users<br/>ç”¨æˆ·è¡¨] --> B[rewrite_history<br/>è½¬å†™å†å²]
    A --> C[publish_tasks<br/>å‘å¸ƒä»»åŠ¡]
    A --> D[follow_circle_tasks<br/>è·Ÿåœˆä»»åŠ¡]
    A --> E[duixueqiu_accounts<br/>å †é›ªçƒè´¦å·]
    A --> F[duixueqiu_video_materials<br/>è§†é¢‘å·ç´ æ]

    style A fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style B fill:#4ecdc4,stroke:#0a9396,color:#fff
    style C fill:#4ecdc4,stroke:#0a9396,color:#fff
    style D fill:#4ecdc4,stroke:#0a9396,color:#fff
    style E fill:#4ecdc4,stroke:#0a9396,color:#fff
    style F fill:#4ecdc4,stroke:#0a9396,color:#fff
```

**è¯´æ˜**:
- `users` æ˜¯æ ¸å¿ƒè¡¨,æ‰€æœ‰ä¸šåŠ¡è¡¨éƒ½å…³è”åˆ°ç”¨æˆ·
- æ‰€æœ‰å…³è”è¡¨çš„ `user_id` **å¿…é¡»æ˜¯UUIDç±»å‹**
- åˆ é™¤ç”¨æˆ·æ—¶,éƒ¨åˆ†å…³è”æ•°æ®ä¼šè¢«çº§è”åˆ é™¤

---

#### æ–‡ç« å¤„ç†æµç¨‹

```mermaid
graph LR
    A[wechat_articles<br/>å…¬ä¼—å·æ–‡ç« ] --> B[rewrite_history<br/>AIè½¬å†™]
    B --> C[publish_tasks<br/>å‘å¸ƒä»»åŠ¡]

    style A fill:#ffd93d,stroke:#f9a825,color:#000
    style B fill:#6bcf7f,stroke:#2e7d32,color:#fff
    style C fill:#4d96ff,stroke:#1565c0,color:#fff
```

**è¯´æ˜**:
- å…¬ä¼—å·æ–‡ç« é‡‡é›†åå­˜å…¥ `wechat_articles`
- ç”¨æˆ·é€‰æ‹©æ–‡ç« è¿›è¡ŒAIè½¬å†™,è®°å½•å­˜å…¥ `rewrite_history`
- è½¬å†™ååˆ›å»ºå‘å¸ƒä»»åŠ¡,å­˜å…¥ `publish_tasks`

---

#### è·Ÿåœˆä»»åŠ¡æµç¨‹

```mermaid
graph LR
    A[ç”¨æˆ·åˆ›å»ºè·Ÿåœˆä»»åŠ¡] --> B[follow_circle_tasks<br/>è·Ÿåœˆä»»åŠ¡è¡¨]
    B --> C{æ˜¯å¦éœ€è¦åˆ é™¤ä¸Šä¸€æ¡?}
    C -->|æ˜¯| D[delete_circle_tasks<br/>åˆ é™¤ä»»åŠ¡è¡¨]
    C -->|å¦| E[ç›´æ¥å‘å¸ƒ]

    style A fill:#e0e0e0,stroke:#9e9e9e,color:#000
    style B fill:#4ecdc4,stroke:#0a9396,color:#fff
    style C fill:#ffe66d,stroke:#f9a825,color:#000
    style D fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style E fill:#6bcf7f,stroke:#2e7d32,color:#fff
```

**è¯´æ˜**:
- è·Ÿåœˆä»»åŠ¡æŒ‰ `task_group_id` åˆ†ç»„
- æ¯æ¡è·Ÿåœˆæœ‰ `circle_index` æ ‡è¯†é¡ºåº
- å¦‚æœéœ€è¦åˆ é™¤ä¸Šä¸€æ¡,ä¼šåˆ›å»ºåˆ é™¤ä»»åŠ¡

---

### å…³é”®çº¦æŸè¯´æ˜

#### 1. user_idç±»å‹çº¦æŸ

**âš ï¸ æœ€é‡è¦çš„çº¦æŸ**:
- `users.id` æ˜¯ `UUID` ç±»å‹
- **æ‰€æœ‰å…³è”è¡¨çš„ `user_id` å¿…é¡»æ˜¯ `UUID` ç±»å‹**
- **ç»å¯¹ä¸èƒ½ä¿®æ”¹ä¸ºå…¶ä»–ç±»å‹**

**å·²ä¿®å¤çš„é—®é¢˜**:
- `duixueqiu_accounts.user_id` - å·²é€šè¿‡è¿ç§»009ä¿®å¤ä¸ºUUID
- `follow_circle_tasks.user_id` - å·²é€šè¿‡è¿ç§»010ä¿®å¤ä¸ºUUID

**æ•™è®­**:
- è¿™ä¸ªé—®é¢˜å·²ç»å¯¼è‡´è¿‡ä¸€æ¬¡ç³»ç»Ÿå´©æºƒ
- **åˆ›å»ºæ–°è¡¨æ—¶å¿…é¡»ç¡®ä¿user_idæ˜¯UUIDç±»å‹**

---

#### 2. å¤–é”®çº§è”åˆ é™¤

**CASCADEåˆ é™¤**:
- `users` â†’ `rewrite_history`: åˆ é™¤ç”¨æˆ·æ—¶,è½¬å†™å†å²è¢«åˆ é™¤
- `users` â†’ `follow_circle_tasks`: åˆ é™¤ç”¨æˆ·æ—¶,è·Ÿåœˆä»»åŠ¡è¢«åˆ é™¤

**SET NULL**:
- `wechat_articles` â†’ `rewrite_history`: åˆ é™¤æ–‡ç« æ—¶,article_idè®¾ä¸ºNULL

**è¯´æ˜**:
- CASCADEåˆ é™¤ç”¨äºç”¨æˆ·ç§æœ‰æ•°æ®
- SET NULLç”¨äºä¿ç•™å†å²è®°å½•

---

#### 3. å”¯ä¸€çº¦æŸ

**usersè¡¨**:
- `username` - ç™»å½•è´¦å·å¿…é¡»å”¯ä¸€

**monitor_configè¡¨**:
- `config_key` - é…ç½®é”®åå¿…é¡»å”¯ä¸€

**duixueqiu_video_materialsè¡¨**:
- `(user_id, thumbnail_url)` - é˜²æ­¢é‡å¤ç´ æ(ä½¿ç”¨ç¼©ç•¥å›¾URLå»é‡)

---

#### 4. æ•°ç»„å­—æ®µ

**TEXT[]ç±»å‹**:
- `wechat_articles.images` - å›¾ç‰‡URLæ•°ç»„
- `rewrite_history.original_images` - åŸå§‹å›¾ç‰‡æ•°ç»„
- `rewrite_history.selected_images` - é€‰æ‹©çš„å›¾ç‰‡æ•°ç»„
- `publish_tasks.images` - å›¾ç‰‡URLæ•°ç»„

**JSONBç±»å‹**:
- `follow_circle_tasks.images` - å›¾ç‰‡URLæ•°ç»„(å­˜å‚¨Storage URL)

**æ³¨æ„**:
- æ•°ç»„å­—æ®µä¸èƒ½ç›´æ¥ç”¨ `=` æ¯”è¾ƒ
- éœ€è¦ä½¿ç”¨ `@>` æˆ– `&&` ç­‰æ•°ç»„æ“ä½œç¬¦

---

## ğŸ“ è¡¨ç»“æ„è¯¦ç»†è¯´æ˜

### 1. users (ç”¨æˆ·è¡¨)

**ç”¨é€”**: å­˜å‚¨ç³»ç»Ÿç”¨æˆ·ä¿¡æ¯

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | UUID | PRIMARY KEY | gen_random_uuid() | **ç”¨æˆ·ID,æ‰€æœ‰å…³è”è¡¨çš„user_idå¿…é¡»æ˜¯UUIDç±»å‹** |
| username | VARCHAR(50) | UNIQUE NOT NULL | - | ç™»å½•è´¦å·,å”¯ä¸€ |
| name | VARCHAR(100) | NOT NULL | - | ç”¨æˆ·å§“å |
| password | VARCHAR(255) | NOT NULL | - | åŠ å¯†åçš„å¯†ç (bcrypt) |
| created_at | TIMESTAMP | - | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NOW() | æ›´æ–°æ—¶é—´(è‡ªåŠ¨æ›´æ–°) |

**ç´¢å¼•**:
- `idx_users_username` - usernameå­—æ®µç´¢å¼•

**è§¦å‘å™¨**:
- `update_users_updated_at` - è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

**âš ï¸ é‡è¦çº¦æŸ**:
- **idå­—æ®µæ˜¯UUIDç±»å‹,æ‰€æœ‰å…³è”è¡¨çš„user_idå¿…é¡»ä¹Ÿæ˜¯UUIDç±»å‹**
- **ç¦æ­¢ä¿®æ”¹idå­—æ®µç±»å‹**
- **ç¦æ­¢åˆ é™¤æˆ–ä¿®æ”¹usernameå­—æ®µ**

---

### 2. wechat_articles (å…¬ä¼—å·æ–‡ç« è¡¨)

**ç”¨é€”**: å­˜å‚¨ä»å…¬ä¼—å·é‡‡é›†çš„æ–‡ç« ä¿¡æ¯

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | UUID | PRIMARY KEY | gen_random_uuid() | æ–‡ç« ID |
| title | VARCHAR(500) | NOT NULL | - | æ–‡ç« æ ‡é¢˜ |
| content | TEXT | - | - | æ–‡ç« æ­£æ–‡(HTMLæ ¼å¼) |
| images | TEXT[] | - | - | æ–‡ç« å›¾ç‰‡URLæ•°ç»„ |
| publish_time | TIMESTAMP | - | - | æ–‡ç« å‘å¸ƒæ—¶é—´ |
| author | VARCHAR(100) | - | - | æ–‡ç« ä½œè€… |
| url | VARCHAR(1000) | - | - | æ–‡ç« åŸæ–‡é“¾æ¥ |
| account_name | VARCHAR(100) | - | - | å…¬ä¼—å·åç§° |
| account_id | VARCHAR(100) | - | - | å…¬ä¼—å·ID |
| status | VARCHAR(50) | - | 'å¾…å¤„ç†' | å¤„ç†çŠ¶æ€ |
| rewritten_content | TEXT | - | - | AIæ”¹å†™åçš„å†…å®¹ |
| created_at | TIMESTAMP | - | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NOW() | æ›´æ–°æ—¶é—´(è‡ªåŠ¨æ›´æ–°) |

**ç´¢å¼•**:
- `idx_articles_account_id` - account_idå­—æ®µç´¢å¼•
- `idx_articles_publish_time` - publish_timeå­—æ®µç´¢å¼•(é™åº)
- `idx_articles_status` - statuså­—æ®µç´¢å¼•

**è§¦å‘å™¨**:
- `update_articles_updated_at` - è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

**statuså­—æ®µå¯é€‰å€¼**:
- `å¾…å¤„ç†` - åˆšé‡‡é›†,æœªå¤„ç†
- `æ”¹å†™ä¸­` - æ­£åœ¨AIæ”¹å†™
- `å·²æ”¹å†™` - æ”¹å†™å®Œæˆ
- `å‘å¸ƒä¸­` - æ­£åœ¨å‘å¸ƒ
- `å·²å‘å¸ƒ` - å‘å¸ƒå®Œæˆ
- `å¤±è´¥` - å¤„ç†å¤±è´¥

**âš ï¸ é‡è¦çº¦æŸ**:
- imageså­—æ®µæ˜¯æ•°ç»„ç±»å‹,å­˜å‚¨å›¾ç‰‡URL
- contentå­—æ®µå­˜å‚¨HTMLæ ¼å¼çš„æ–‡ç« å†…å®¹
- statuså­—æ®µå¿…é¡»æ˜¯é¢„å®šä¹‰çš„å€¼ä¹‹ä¸€

---

### 3. monitor_config (ç›‘æ§é…ç½®è¡¨)

**ç”¨é€”**: å­˜å‚¨å…¬ä¼—å·ç›‘æ§çš„é…ç½®ä¿¡æ¯

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | UUID | PRIMARY KEY | gen_random_uuid() | é…ç½®ID |
| config_key | VARCHAR(100) | UNIQUE NOT NULL | - | é…ç½®é”®å |
| config_value | TEXT | NOT NULL | - | é…ç½®å€¼ |
| description | TEXT | - | - | é…ç½®è¯´æ˜ |
| created_at | TIMESTAMP | - | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NOW() | æ›´æ–°æ—¶é—´(è‡ªåŠ¨æ›´æ–°) |

**ç´¢å¼•**:
- `idx_monitor_config_key` - config_keyå­—æ®µç´¢å¼•

**è§¦å‘å™¨**:
- `update_monitor_config_updated_at` - è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

**é»˜è®¤é…ç½®**:
- `sync_interval_minutes` = `30` - è‡ªåŠ¨åŒæ­¥æ–‡ç« çš„æ—¶é—´é—´éš”(åˆ†é’Ÿ)

**âš ï¸ é‡è¦çº¦æŸ**:
- config_keyå¿…é¡»å”¯ä¸€
- ä¸è¦éšæ„ä¿®æ”¹config_key,ä¼šå½±å“ç³»ç»ŸåŠŸèƒ½

---

### 4. rewrite_history (è½¬å†™å†å²è¡¨)

**ç”¨é€”**: å­˜å‚¨æ–‡ç« AIæ”¹å†™çš„å†å²è®°å½•

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | UUID | PRIMARY KEY | gen_random_uuid() | è½¬å†™è®°å½•ID |
| user_id | UUID | FOREIGN KEY â†’ users(id) | - | ç”¨æˆ·ID,**å¿…é¡»æ˜¯UUIDç±»å‹** |
| article_id | UUID | FOREIGN KEY â†’ wechat_articles(id) | - | å…³è”çš„æ–‡ç« ID |
| original_content | TEXT | NOT NULL | - | åŸå§‹æ–‡ç« å†…å®¹ |
| original_images | TEXT[] | - | - | åŸå§‹å›¾ç‰‡URLæ•°ç»„ |
| rewritten_content | TEXT | NOT NULL | - | AIè½¬å†™åçš„å†…å®¹ |
| selected_images | TEXT[] | - | - | ç”¨æˆ·é€‰æ‹©çš„å›¾ç‰‡URLæ•°ç»„ |
| coze_workflow_id | VARCHAR(100) | - | - | Cozeå·¥ä½œæµID |
| status | VARCHAR(50) | - | 'completed' | è½¬å†™çŠ¶æ€ |
| error_message | TEXT | - | - | é”™è¯¯ä¿¡æ¯ |
| created_at | TIMESTAMP | - | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NOW() | æ›´æ–°æ—¶é—´(è‡ªåŠ¨æ›´æ–°) |

**ç´¢å¼•**:
- `idx_rewrite_history_user_id` - user_idå­—æ®µç´¢å¼•
- `idx_rewrite_history_article_id` - article_idå­—æ®µç´¢å¼•
- `idx_rewrite_history_created_at` - created_atå­—æ®µç´¢å¼•(é™åº)

**å¤–é”®çº¦æŸ**:
- `user_id` â†’ `users(id)` ON DELETE CASCADE
- `article_id` â†’ `wechat_articles(id)` ON DELETE SET NULL

**è§¦å‘å™¨**:
- `update_rewrite_history_updated_at` - è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

**statuså­—æ®µå¯é€‰å€¼**:
- `processing` - å¤„ç†ä¸­
- `completed` - å®Œæˆ
- `failed` - å¤±è´¥

**âš ï¸ é‡è¦çº¦æŸ**:
- **user_idå¿…é¡»æ˜¯UUIDç±»å‹,ä¸users.idç±»å‹ä¸€è‡´**
- åˆ é™¤ç”¨æˆ·æ—¶,ç›¸å…³è½¬å†™å†å²ä¼šè¢«çº§è”åˆ é™¤
- åˆ é™¤æ–‡ç« æ—¶,article_idä¼šè¢«è®¾ç½®ä¸ºNULL

---

### 5. publish_tasks (å‘å¸ƒä»»åŠ¡è¡¨)

**ç”¨é€”**: å­˜å‚¨æœ‹å‹åœˆå‘å¸ƒä»»åŠ¡

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | UUID | PRIMARY KEY | gen_random_uuid() | ä»»åŠ¡ID |
| user_id | UUID | NOT NULL | - | ç”¨æˆ·ID,**å¿…é¡»æ˜¯UUIDç±»å‹** |
| rewrite_id | UUID | - | - | å…³è”çš„è½¬å†™è®°å½•ID |
| task_title | VARCHAR(255) | - | - | ä»»åŠ¡æ ‡é¢˜ |
| content | TEXT | NOT NULL | - | å‘å¸ƒå†…å®¹ |
| images | TEXT[] | - | - | å›¾ç‰‡URLæ•°ç»„ |
| wechat_account | VARCHAR(100) | - | - | å¾®ä¿¡è´¦å· |
| publish_time | TIMESTAMP | NOT NULL | - | å‘å¸ƒæ—¶é—´ |
| is_immediate | BOOLEAN | - | false | æ˜¯å¦ç«‹å³å‘å¸ƒ |
| random_delay_minutes | INTEGER | - | 0 | éšæœºå»¶è¿Ÿåˆ†é’Ÿæ•° |
| status | VARCHAR(50) | - | 'pending' | ä»»åŠ¡çŠ¶æ€ |
| duixueqiu_task_id | VARCHAR(100) | - | - | å †é›ªçƒä»»åŠ¡ID |
| error_message | TEXT | - | - | é”™è¯¯ä¿¡æ¯ |
| created_at | TIMESTAMP | - | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NOW() | æ›´æ–°æ—¶é—´(è‡ªåŠ¨æ›´æ–°) |

**ç´¢å¼•**:
- `idx_publish_tasks_user_id` - user_idå­—æ®µç´¢å¼•
- `idx_publish_tasks_publish_time` - publish_timeå­—æ®µç´¢å¼•
- `idx_publish_tasks_status` - statuså­—æ®µç´¢å¼•

**è§¦å‘å™¨**:
- `update_publish_tasks_updated_at` - è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

**statuså­—æ®µå¯é€‰å€¼**:
- `pending` - å¾…å‘å¸ƒ
- `processing` - å‘å¸ƒä¸­
- `completed` - å·²å®Œæˆ
- `failed` - å¤±è´¥

**âš ï¸ é‡è¦çº¦æŸ**:
- **user_idå¿…é¡»æ˜¯UUIDç±»å‹**
- imageså­—æ®µæ˜¯æ•°ç»„ç±»å‹
- publish_timeä¸èƒ½ä¸ºç©º

---

## ğŸ”— è¡¨å…³è”å…³ç³»

### å¤–é”®å…³ç³»å›¾

```
users (id: UUID)
  â”œâ”€â†’ rewrite_history (user_id: UUID) [CASCADE]
  â”œâ”€â†’ publish_tasks (user_id: UUID)
  â”œâ”€â†’ follow_circle_tasks (user_id: UUID) [CASCADE]
  â””â”€â†’ duixueqiu_accounts (user_id: UUID)

wechat_articles (id: UUID)
  â””â”€â†’ rewrite_history (article_id: UUID) [SET NULL]

rewrite_history (id: UUID)
  â””â”€â†’ publish_tasks (rewrite_id: UUID)
```

### å…³é”®çº¦æŸè¯´æ˜

1. **users â†’ rewrite_history**: CASCADEåˆ é™¤
   - åˆ é™¤ç”¨æˆ·æ—¶,ç›¸å…³è½¬å†™å†å²ä¼šè¢«è‡ªåŠ¨åˆ é™¤

2. **wechat_articles â†’ rewrite_history**: SET NULL
   - åˆ é™¤æ–‡ç« æ—¶,è½¬å†™å†å²çš„article_idä¼šè¢«è®¾ç½®ä¸ºNULL,ä¿ç•™è½¬å†™è®°å½•

3. **users â†’ follow_circle_tasks**: CASCADEåˆ é™¤
   - åˆ é™¤ç”¨æˆ·æ—¶,ç›¸å…³è·Ÿåœˆä»»åŠ¡ä¼šè¢«è‡ªåŠ¨åˆ é™¤

---

## ğŸ“Œ ç´¢å¼•å’Œè§¦å‘å™¨

### è‡ªåŠ¨æ›´æ–°è§¦å‘å™¨

æ‰€æœ‰è¡¨éƒ½æœ‰ `updated_at` å­—æ®µè‡ªåŠ¨æ›´æ–°è§¦å‘å™¨:

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

### é‡è¦ç´¢å¼•

**æ€§èƒ½ä¼˜åŒ–ç´¢å¼•**:
- `idx_articles_publish_time` - æŒ‰å‘å¸ƒæ—¶é—´é™åºæŸ¥è¯¢æ–‡ç« 
- `idx_rewrite_history_created_at` - æŒ‰åˆ›å»ºæ—¶é—´é™åºæŸ¥è¯¢è½¬å†™å†å²
- `idx_publish_tasks_publish_time` - æŒ‰å‘å¸ƒæ—¶é—´æŸ¥è¯¢ä»»åŠ¡

**æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•**:
- `idx_articles_status` - æŒ‰çŠ¶æ€ç­›é€‰æ–‡ç« 
- `idx_publish_tasks_status` - æŒ‰çŠ¶æ€ç­›é€‰ä»»åŠ¡

---

### 6. follow_circle_tasks (è·Ÿåœˆä»»åŠ¡è¡¨)

**ç”¨é€”**: å­˜å‚¨è‡ªåŠ¨è·Ÿåœˆå‘å¸ƒä»»åŠ¡

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | SERIAL | PRIMARY KEY | - | ä»»åŠ¡ID(è‡ªå¢) |
| user_id | UUID | FOREIGN KEY â†’ users(id) | - | ç”¨æˆ·ID,**å¿…é¡»æ˜¯UUIDç±»å‹** |
| task_group_id | VARCHAR(100) | NOT NULL | - | ä»»åŠ¡ç»„ID(ä¾‹å¦‚:è·Ÿåœˆ_1730000000000) |
| circle_index | INT | NOT NULL | - | ç¬¬å‡ æ¡è·Ÿåœˆ(1,2,3...) |
| content | TEXT | NOT NULL | - | æœ‹å‹åœˆæ–‡å­—å†…å®¹ |
| images | JSONB | - | - | å›¾ç‰‡åˆ—è¡¨JSON |
| publish_time | TIMESTAMP | NOT NULL | - | è®¡åˆ’å‘å¸ƒæ—¶é—´ |
| delete_previous | BOOLEAN | - | false | æ˜¯å¦éœ€è¦åˆ é™¤ä¸Šä¸€æ¡æœ‹å‹åœˆ |
| previous_title | VARCHAR(200) | - | - | ä¸Šä¸€æ¡æœ‹å‹åœˆçš„æ ‡é¢˜(ç”¨äºè¯†åˆ«åˆ é™¤) |
| status | VARCHAR(20) | - | 'pending' | ä»»åŠ¡çŠ¶æ€ |
| error_message | TEXT | - | - | é”™è¯¯ä¿¡æ¯ |
| created_at | TIMESTAMP | - | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- `idx_follow_circle_tasks_group` - task_group_idå­—æ®µç´¢å¼•
- `idx_follow_circle_tasks_status` - statuså­—æ®µç´¢å¼•
- `idx_follow_circle_tasks_publish_time` - publish_timeå­—æ®µç´¢å¼•

**å¤–é”®çº¦æŸ**:
- `user_id` â†’ `users(id)` ON DELETE CASCADE

**statuså­—æ®µå¯é€‰å€¼**:
- `pending` - å¾…æ‰§è¡Œ
- `completed` - å·²å®Œæˆ
- `failed` - å¤±è´¥

**âš ï¸ é‡è¦çº¦æŸ**:
- **user_idå¿…é¡»æ˜¯UUIDç±»å‹** (å·²é€šè¿‡è¿ç§»010ä¿®å¤)
- imageså­—æ®µæ˜¯JSONBç±»å‹,å­˜å‚¨æ ¼å¼: `[{url: '', base64: ''}]`
- task_group_idç”¨äºå…³è”åŒä¸€æ‰¹è·Ÿåœˆä»»åŠ¡

---

### 7. delete_circle_tasks (åˆ é™¤ä»»åŠ¡è¡¨)

**ç”¨é€”**: å­˜å‚¨è·Ÿåœˆåˆ é™¤ä»»åŠ¡

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | SERIAL | PRIMARY KEY | - | ä»»åŠ¡ID(è‡ªå¢) |
| task_group_id | VARCHAR(255) | NOT NULL | - | ä»»åŠ¡ç»„ID(ä¾‹å¦‚:è·Ÿåœˆ_1729872000000) |
| circle_index | INTEGER | NOT NULL | - | ç¬¬å‡ æ¡æœ‹å‹åœˆ(1,2,3...) |
| delete_title | VARCHAR(255) | NOT NULL | - | è¦åˆ é™¤çš„ä»»åŠ¡æ ‡é¢˜ |
| delete_content | TEXT | NOT NULL | - | æœ‹å‹åœˆå†…å®¹(ç”¨äºåŒé‡éªŒè¯) |
| delete_time | TIMESTAMP | NOT NULL | - | åˆ é™¤æ—¶é—´ |
| status | VARCHAR(20) | - | 'pending' | ä»»åŠ¡çŠ¶æ€ |
| error_message | TEXT | - | - | é”™è¯¯ä¿¡æ¯ |
| created_at | TIMESTAMP | - | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NOW() | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- `idx_delete_circle_tasks_group` - task_group_idå­—æ®µç´¢å¼•
- `idx_delete_circle_tasks_status` - statuså­—æ®µç´¢å¼•

**statuså­—æ®µå¯é€‰å€¼**:
- `pending` - å¾…æ‰§è¡Œ
- `completed` - å·²å®Œæˆ
- `failed` - å¤±è´¥

**âš ï¸ é‡è¦çº¦æŸ**:
- delete_contentç”¨äºåŒé‡éªŒè¯,ç¡®ä¿åˆ é™¤æ­£ç¡®çš„æœ‹å‹åœˆ
- task_group_idä¸follow_circle_tasksè¡¨å…³è”

---

### 8. duixueqiu_accounts (å †é›ªçƒè´¦å·è¡¨)

**ç”¨é€”**: å­˜å‚¨å †é›ªçƒè´¦å·ä¿¡æ¯

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | SERIAL | PRIMARY KEY | - | è´¦å·ID(è‡ªå¢) |
| user_id | UUID | NOT NULL | - | ç”¨æˆ·ID,**å¿…é¡»æ˜¯UUIDç±»å‹** |
| account_name | VARCHAR(100) | NOT NULL | - | è´¦å·åç§°(ç”¨æˆ·è‡ªå®šä¹‰) |
| username | VARCHAR(100) | NOT NULL | - | å †é›ªçƒç”¨æˆ·å |
| password | TEXT | NOT NULL | - | å †é›ªçƒå¯†ç (æ˜æ–‡å­˜å‚¨,å¾…åŠ å¯†) |
| is_default | BOOLEAN | - | false | æ˜¯å¦é»˜è®¤è´¦å· |
| status | VARCHAR(20) | - | 'active' | è´¦å·çŠ¶æ€ |
| created_at | TIMESTAMP | - | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- `idx_duixueqiu_accounts_user_id` - user_idå­—æ®µç´¢å¼•
- `idx_duixueqiu_accounts_status` - statuså­—æ®µç´¢å¼•

**statuså­—æ®µå¯é€‰å€¼**:
- `active` - æ¿€æ´»
- `inactive` - åœç”¨

**âš ï¸ é‡è¦çº¦æŸ**:
- **user_idå¿…é¡»æ˜¯UUIDç±»å‹** (å·²é€šè¿‡è¿ç§»009ä¿®å¤)
- **å¯†ç å½“å‰æ˜¯æ˜æ–‡å­˜å‚¨,éœ€è¦åç»­æ·»åŠ åŠ å¯†**
- æ¯ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå †é›ªçƒè´¦å·
- is_defaultæ ‡è®°é»˜è®¤ä½¿ç”¨çš„è´¦å·

**ğŸš¨ å®‰å…¨è­¦å‘Š**:
- å¯†ç æ˜æ–‡å­˜å‚¨å­˜åœ¨å®‰å…¨é£é™©
- å»ºè®®åç»­æ·»åŠ åŠ å¯†åŠŸèƒ½

---

### 9. duixueqiu_video_materials (è§†é¢‘å·ç´ æè¡¨)

**ç”¨é€”**: å­˜å‚¨å †é›ªçƒè§†é¢‘å·ç´ æåº“

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | SERIAL | PRIMARY KEY | - | ç´ æID(è‡ªå¢) |
| user_id | UUID | NOT NULL | - | ç”¨æˆ·ID,**å¿…é¡»æ˜¯UUIDç±»å‹** |
| author_name | VARCHAR(200) | - | - | è§†é¢‘å·å‘å¸ƒè€…åç§° |
| content_desc | TEXT | - | - | è§†é¢‘å·å†…å®¹æè¿°(å¸¦è¯é¢˜æ ‡ç­¾) |
| material_index | INT | - | - | ç´ æåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½® |
| page_number | INT | - | 1 | ç´ ææ‰€åœ¨é¡µç  |
| group_name | VARCHAR(100) | - | 'å…¬å…±ç´ æåˆ†ç»„' | ç´ æåˆ†ç»„ |
| sync_time | TIMESTAMP | - | NOW() | æœ€ååŒæ­¥æ—¶é—´ |
| create_time | TIMESTAMP | - | NOW() | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- `idx_duixueqiu_video_materials_user_id` - user_idå­—æ®µç´¢å¼•
- `idx_duixueqiu_video_materials_author_name` - author_nameå­—æ®µç´¢å¼•
- `idx_duixueqiu_video_materials_sync_time` - sync_timeå­—æ®µç´¢å¼•

**å”¯ä¸€çº¦æŸ**:
- `UNIQUE(user_id, author_name, content_desc)` - é˜²æ­¢é‡å¤ç´ æ

**âš ï¸ é‡è¦çº¦æŸ**:
- user_idå¿…é¡»æ˜¯UUIDç±»å‹
- å”¯ä¸€çº¦æŸé˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤æ·»åŠ ç›¸åŒç´ æ
- material_indexç”¨äºPuppeteerå®šä½ç´ æä½ç½®

---

### 9. message_send_history (æ¶ˆæ¯å‘é€å†å²è¡¨)

**ç”¨é€”**: è®°å½•å¾®ä¿¡å¥½å‹è§¦è¾¾ä»»åŠ¡çš„æ¶ˆæ¯å‘é€å†å²,å®ç°é˜²é‡å¤å‘é€å’Œæš‚åœ/æ¢å¤åŠŸèƒ½

**è¡¨ç»“æ„**:

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | è‡ªå¢ä¸»é”® |
| user_id | UUID | NOT NULL | - | ç”¨æˆ·ID(å…³è”usersè¡¨) |
| friend_id | BIGINT | NOT NULL | - | å¥½å‹ID(å…³è”duixueqiu_friendsè¡¨) |
| friend_name | TEXT | NOT NULL | - | å¥½å‹åç§° |
| message_type | TEXT | NOT NULL | - | æ¶ˆæ¯ç±»å‹(text/video/link/image/combined) |
| message_content_hash | TEXT | NOT NULL | - | æ¶ˆæ¯å†…å®¹SHA-256å“ˆå¸Œå€¼ |
| message_content | JSONB | NOT NULL | - | å®Œæ•´æ¶ˆæ¯å†…å®¹ |
| sent_at | TIMESTAMP WITH TIME ZONE | - | NOW() | å‘é€æ—¶é—´ |
| task_id | TEXT | - | - | ä»»åŠ¡ID(å¯é€‰) |
| created_at | TIMESTAMP WITH TIME ZONE | - | NOW() | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- `idx_message_send_history_lookup` - (user_id, friend_id, message_content_hash)å¤åˆç´¢å¼•,ç”¨äºå¿«é€ŸæŸ¥è¯¢
- `idx_message_send_history_sent_at` - sent_atå­—æ®µç´¢å¼•(é™åº)
- `idx_message_send_history_user_id` - user_idå­—æ®µç´¢å¼•

**CHECKçº¦æŸ**:
- `message_type IN ('text', 'video', 'link', 'image', 'combined')` - é™åˆ¶æ¶ˆæ¯ç±»å‹

**âš ï¸ é‡è¦çº¦æŸ**:
- **user_idå¿…é¡»æ˜¯UUIDç±»å‹** - å…³è”usersè¡¨
- **friend_idå¿…é¡»æ˜¯BIGINTç±»å‹** - å…³è”duixueqiu_friendsè¡¨,ä¸èƒ½æ˜¯UUID
- message_content_hashç”¨äºå¿«é€Ÿæ¯”å¯¹,é¿å…å…¨æ–‡æ¯”å¯¹JSONB
- å¤åˆç´¢å¼•(user_id, friend_id, message_content_hash)ç¡®ä¿æŸ¥è¯¢æ€§èƒ½

**æ ¸å¿ƒåŠŸèƒ½**:

1. **é˜²é‡å¤å‘é€**:
   - å‘é€å‰æŸ¥è¯¢`(user_id, friend_id, message_content_hash)`
   - å¦‚æœå­˜åœ¨è®°å½•,è·³è¿‡è¯¥å¥½å‹
   - å¦‚æœä¸å­˜åœ¨,å‘é€åæ’å…¥è®°å½•

2. **æš‚åœ/æ¢å¤**:
   - æš‚åœæ—¶ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
   - æ¢å¤æ—¶é‡æ–°è°ƒç”¨ä¸»å‡½æ•°
   - ä¾èµ–é˜²é‡å¤æœºåˆ¶è‡ªåŠ¨è·³è¿‡å·²å‘é€çš„æ¶ˆæ¯

3. **ç»„åˆå‘é€**:
   - æ¯ç§æ¶ˆæ¯ç±»å‹ç‹¬ç«‹è®°å½•
   - ä¾‹å¦‚:å‘é€æ–‡å­—+è§†é¢‘å·,ä¼šæ’å…¥2æ¡è®°å½•
   - æ¢å¤æ—¶åªå‘é€æœªè®°å½•çš„ç±»å‹

**è¿ç§»æ–‡ä»¶**: `pyq-backend/supabase/migrations/20251201_create_message_send_history.sql`

**ç›¸å…³æ–‡æ¡£**:
- [è„šæœ¬2æ–‡æ¡£ - é˜²é‡å¤å‘é€æœºåˆ¶](./è„šæœ¬2-å¾®ä¿¡å¥½å‹è§¦è¾¾.md#1-é˜²é‡å¤å‘é€æœºåˆ¶)
- [å¸¸è§é—®é¢˜ - æš‚åœ/æ¢å¤ä¸å·¥ä½œ](./å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ.md#q5-æš‚åœæ¢å¤åŠŸèƒ½ä¸å·¥ä½œé‡å¤å‘é€æ¶ˆæ¯-é‡è¦)

---

## ğŸ—„ï¸ Supabase Storageé…ç½®

### æ–¹æ¡ˆæ¦‚è¿°

#### é—®é¢˜èƒŒæ™¯

- **åŸæ–¹æ¡ˆ**: å›¾ç‰‡Base64ç›´æ¥å­˜å‚¨åœ¨PostgreSQLæ•°æ®åº“ä¸­
- **é—®é¢˜**: 10MBå›¾ç‰‡è½¬Base64åçº¦13-14MB,æ’å…¥æ•°æ®åº“æ—¶è¶…è¿‡120ç§’è¶…æ—¶é™åˆ¶
- **å½±å“**: è·Ÿåœˆä»»åŠ¡åˆ›å»ºå¤±è´¥,ç”¨æˆ·ä½“éªŒå·®

#### è§£å†³æ–¹æ¡ˆ

- **æ–°æ–¹æ¡ˆ**: å›¾ç‰‡ä¸Šä¼ åˆ°Supabase Storage,æ•°æ®åº“åªå­˜å‚¨å›¾ç‰‡URL
- **ä¼˜åŠ¿**:
  - âœ… ä¸ä¼šè¶…æ—¶ - Storageä¸“é—¨å¤„ç†å¤§æ–‡ä»¶
  - âœ… ä¿æŒåŸå›¾ - ä¸å‹ç¼©,æœ‹å‹åœˆçœ‹åˆ°çš„æ˜¯åŸå›¾è´¨é‡
  - âœ… å…è´¹ä½¿ç”¨ - 1GBå…è´¹é¢åº¦å¤Ÿç”¨å¾ˆä¹…
  - âœ… é€Ÿåº¦æ›´å¿« - æ•°æ®åº“åªå­˜URL,æŸ¥è¯¢å¾ˆå¿«

---

### æŠ€æœ¯æ¶æ„

#### æ•°æ®æµç¨‹

```
å‰ç«¯ä¸Šä¼ å›¾ç‰‡ (Base64)
    â†“
åç«¯æ¥æ”¶ (follow-circle.service.ts)
    â†“
ä¸Šä¼ åˆ°Storage (storage.service.ts)
    â†“
è¿”å›å›¾ç‰‡URL
    â†“
æ•°æ®åº“å­˜å‚¨URL (follow_circle_tasksè¡¨)
    â†“
å‘å¸ƒæ—¶ä¸‹è½½å›¾ç‰‡ (ä»Storage URLä¸‹è½½ä¸ºBase64)
    â†“
ä¸Šä¼ åˆ°å †é›ªçƒ (Puppeteerè‡ªåŠ¨åŒ–)
```

#### æ–‡ä»¶ç»“æ„

```
pyq-backend/src/
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ storage.module.ts          # Storageæ¨¡å—
â”‚   â””â”€â”€ storage.service.ts         # StorageæœåŠ¡(æ ¸å¿ƒ)
â”œâ”€â”€ automation/
â”‚   â”œâ”€â”€ automation.module.ts       # å¯¼å…¥StorageModule
â”‚   â””â”€â”€ follow-circle.service.ts   # ä½¿ç”¨StorageService
â””â”€â”€ scheduler/
    â””â”€â”€ scheduler.service.ts       # å®šæ—¶æ¸…ç†ä»»åŠ¡
```

---

### Bucketé…ç½®

#### åˆ›å»ºBucket

åœ¨Supabaseæ§åˆ¶å°:
1. è¿›å…¥ **Storage** â†’ **New Bucket**
2. Bucketåç§°: `follow-circle-images`
3. **Public bucket**: âœ… å‹¾é€‰
4. ç‚¹å‡» **Create bucket**

#### RLSç­–ç•¥é…ç½®

åœ¨Supabase SQL Editoræ‰§è¡Œ:

```sql
-- å…è®¸æ‰€æœ‰äººä¸Šä¼  (INSERT)
CREATE POLICY "Allow public upload to follow-circle-images"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'follow-circle-images');

-- å…è®¸æ‰€æœ‰äººè¯»å– (SELECT)
CREATE POLICY "Allow public read from follow-circle-images"
ON storage.objects FOR SELECT
USING (bucket_id = 'follow-circle-images');

-- å…è®¸æ‰€æœ‰äººæ›´æ–° (UPDATE)
CREATE POLICY "Allow public update to follow-circle-images"
ON storage.objects FOR UPDATE
USING (bucket_id = 'follow-circle-images');

-- å…è®¸æ‰€æœ‰äººåˆ é™¤ (DELETE)
CREATE POLICY "Allow public delete from follow-circle-images"
ON storage.objects FOR DELETE
USING (bucket_id = 'follow-circle-images');
```

---

### æ ¸å¿ƒå®ç°

#### Storage Service (storage.service.ts)

**ä¸Šä¼ å›¾ç‰‡**:
```typescript
async uploadFollowCircleImage(base64Data: string, taskGroupId: string, index: number): Promise<string> {
  // 1. è§£æBase64æ•°æ®,æå–æ ¼å¼(jpg/png/jpeg)
  const matches = base64Data.match(/^data:image\/(png|jpg|jpeg);base64,(.+)$/);

  // 2. ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶è·¯å¾„ - é¿å…ä¸­æ–‡å­—ç¬¦
  const timestamp = taskGroupId.split('_').pop();
  const fileName = `${timestamp}_${index}.${ext}`;
  const folderName = `task_${timestamp}`;
  const filePath = `${folderName}/${fileName}`;

  // 3. ä¸Šä¼ åˆ°Storage
  await this.supabase.storage
    .from('follow-circle-images')
    .upload(filePath, buffer, {
      contentType: `image/${ext}`,
      upsert: false,
    });

  // 4. è·å–å…¬å¼€URL
  const { data: urlData } = this.supabase.storage
    .from('follow-circle-images')
    .getPublicUrl(filePath);

  return urlData.publicUrl;
}
```

**æ‰¹é‡ä¸Šä¼ **:
```typescript
async uploadFollowCircleImages(base64Images: string[], taskGroupId: string): Promise<string[]> {
  const uploadPromises = base64Images.map((base64, index) =>
    this.uploadFollowCircleImage(base64, taskGroupId, index)
  );
  return Promise.all(uploadPromises);
}
```

**ä¸‹è½½å›¾ç‰‡**:
```typescript
async downloadImageAsBase64(imageUrl: string): Promise<string> {
  // 1. ä»URLæå–æ–‡ä»¶è·¯å¾„
  const urlObj = new URL(imageUrl);
  const pathParts = urlObj.pathname.split('/');
  const filePath = pathParts.slice(-2).join('/');

  // 2. ä»Storageä¸‹è½½
  const { data, error } = await this.supabase.storage
    .from('follow-circle-images')
    .download(filePath);

  // 3. è½¬æ¢ä¸ºBase64
  const buffer = Buffer.from(await data.arrayBuffer());
  const base64 = buffer.toString('base64');
  const ext = filePath.split('.').pop();

  return `data:image/${ext};base64,${base64}`;
}
```

---

### å®šæ—¶æ¸…ç†ä»»åŠ¡

#### Scheduler Service (scheduler.service.ts)

```typescript
@Cron('0 3 * * *')  // æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ
async cleanOldFollowCircleImages() {
  this.logger.log('ğŸ§¹ å¼€å§‹æ¸…ç†7å¤©å‰çš„è·Ÿåœˆå›¾ç‰‡...');
  const deletedCount = await this.storageService.cleanOldFollowCircleImages();
  this.logger.log(`âœ… è·Ÿåœˆå›¾ç‰‡æ¸…ç†å®Œæˆ, åˆ é™¤äº† ${deletedCount} ä¸ªä»»åŠ¡ç»„çš„å›¾ç‰‡`);
}
```

#### æ¸…ç†é€»è¾‘

```typescript
async cleanOldFollowCircleImages(): Promise<number> {
  // 1. æŸ¥è¯¢7å¤©å‰å®Œæˆçš„ä»»åŠ¡
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

  const { data: oldTasks } = await this.supabase
    .from('follow_circle_tasks')
    .select('task_group_id')
    .eq('status', 'completed')
    .lt('updated_at', sevenDaysAgo.toISOString());

  // 2. åˆ é™¤å¯¹åº”çš„å›¾ç‰‡
  for (const taskGroupId of taskGroupIds) {
    await this.deleteFollowCircleTaskImages(taskGroupId);
  }

  return deletedCount;
}
```

---

### å®¹é‡ç®¡ç†

#### å…è´¹é¢åº¦

- **Storageå®¹é‡**: 1GB
- **æ•°æ®åº“å®¹é‡**: 500MB
- **å•æ–‡ä»¶å¤§å°**: æœ€å¤§50MB

#### å®¹é‡ä¼°ç®—

- **å•å¼ å›¾ç‰‡**: å¹³å‡5MB
- **å¯å­˜å‚¨**: çº¦200å¼ å›¾ç‰‡
- **è·Ÿåœˆä»»åŠ¡**: æ¯ä¸ªä»»åŠ¡çº¦15-20MB
- **1GBå¯æ”¯æŒ**: çº¦50ä¸ªè·Ÿåœˆä»»åŠ¡

#### è‡ªåŠ¨æ¸…ç†ç­–ç•¥

1. **å®šæ—¶æ¸…ç†**: æ¯å¤©å‡Œæ™¨3ç‚¹æ¸…ç†7å¤©å‰å®Œæˆçš„ä»»åŠ¡å›¾ç‰‡
2. **å®¹é‡ç›‘æ§**: è¶…è¿‡800MBæ—¶å¼ºåˆ¶æ¸…ç†
3. **ä¿ç•™ç­–ç•¥**: æœ€è¿‘7å¤©çš„ä»»åŠ¡å›¾ç‰‡ä¿ç•™

---

### æ•…éšœæ’æŸ¥

#### é—®é¢˜1: ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**: å›¾ç‰‡ä¸Šä¼ åˆ°Storageå¤±è´¥

**æ£€æŸ¥**:
```bash
# 1. æ£€æŸ¥Bucketæ˜¯å¦å­˜åœ¨
# åœ¨Supabaseæ§åˆ¶å° Storage ä¸­æŸ¥çœ‹

# 2. æ£€æŸ¥RLSç­–ç•¥
# åœ¨Supabase SQL Editoræ‰§è¡Œ:
SELECT * FROM storage.policies WHERE bucket_id = 'follow-circle-images';

# 3. æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs pyq-backend | grep Storage
```

#### é—®é¢˜2: ä¸‹è½½å¤±è´¥

**ç—‡çŠ¶**: ä»Storageä¸‹è½½å›¾ç‰‡å¤±è´¥

**æ£€æŸ¥**:
```bash
# 1. æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®
# URLæ ¼å¼: https://upcsdbcpmzpywvykiqtu.supabase.co/storage/v1/object/public/follow-circle-images/task_xxx/xxx.jpg

# 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
# åœ¨Supabaseæ§åˆ¶å° Storage ä¸­æŸ¥çœ‹

# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
curl -I "å›¾ç‰‡URL"
```

#### é—®é¢˜3: æ¸…ç†ä»»åŠ¡å¤±è´¥

**ç—‡çŠ¶**: å®šæ—¶æ¸…ç†ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œ

**æ£€æŸ¥**:
```bash
# 1. æŸ¥çœ‹å®šæ—¶ä»»åŠ¡æ—¥å¿—
pm2 logs pyq-backend | grep "æ¸…ç†"

# 2. æ£€æŸ¥Cronè¡¨è¾¾å¼
# '0 3 * * *' = æ¯å¤©å‡Œæ™¨3ç‚¹

# 3. æ‰‹åŠ¨è§¦å‘æ¸…ç†
# åœ¨ä»£ç ä¸­è°ƒç”¨ cleanOldFollowCircleImages()
```

---

## ğŸ“Š æ•°æ®åº“è¿ç§»å†å²

### è¿ç§»æ–‡ä»¶æ¸…å•

| æ–‡ä»¶å | æ‰§è¡Œæ—¶é—´ | è¯´æ˜ |
|--------|---------|------|
| `004_create_delete_circle_tasks.sql` | 2025-10-25 | åˆ›å»ºåˆ é™¤ä»»åŠ¡è¡¨ |
| `005_create_follow_circle_tasks.sql` | 2025-10-27 | åˆ›å»ºè·Ÿåœˆä»»åŠ¡è¡¨ |
| `006_add_content_type_to_follow_circle.sql` | 2025-10-27 | æ·»åŠ å†…å®¹ç±»å‹å­—æ®µ |
| `007_add_group_id_to_follow_circle.sql` | 2025-10-27 | æ·»åŠ åˆ†ç»„IDå­—æ®µ |
| `008_create_duixueqiu_accounts.sql` | 2025-10-27 | åˆ›å»ºå †é›ªçƒè´¦å·è¡¨ |
| `009_add_user_id_to_follow_circle.sql` | 2025-10-27 | æ·»åŠ user_idå­—æ®µ |
| `009_fix_duixueqiu_accounts_user_id_type.sql` | 2025-10-29 | **ä¿®å¤user_idç±»å‹ä¸ºUUID** |
| `009_fix_user_id_safe.sql` | 2025-10-29 | **å®‰å…¨ä¿®å¤user_idç±»å‹** |
| `010_fix_follow_circle_tasks_user_id.sql` | 2025-10-29 | **ä¿®å¤è·Ÿåœˆä»»åŠ¡è¡¨user_idç±»å‹** |
| `011_create_duixueqiu_video_materials.sql` | 2025-11-10 | åˆ›å»ºè§†é¢‘å·ç´ æè¡¨ |

### é‡è¦è¿ç§»è¯´æ˜

**user_idç±»å‹ä¿®å¤ (è¿ç§»009å’Œ010)**:
- **é—®é¢˜**: åˆå§‹åˆ›å»ºæ—¶user_idæ˜¯INTEGERç±»å‹
- **å½±å“**: ä¸users.id(UUID)ç±»å‹ä¸åŒ¹é…,æ— æ³•å»ºç«‹å¤–é”®
- **è§£å†³**: é€šè¿‡è¿ç§»009å’Œ010ä¿®å¤ä¸ºUUIDç±»å‹
- **æ•™è®­**: **åˆ›å»ºè¡¨æ—¶å¿…é¡»ç¡®ä¿user_idæ˜¯UUIDç±»å‹**

**âš ï¸ é‡è¦è­¦å‘Š**:
- è¿™ä¸ªé—®é¢˜å·²ç»ä¿®å¤è¿‡ä¸€æ¬¡
- **ç»å¯¹ä¸è¦å†æ¬¡ä¿®æ”¹user_idç±»å‹**
- **æ–°å»ºè¡¨æ—¶å¿…é¡»ç¡®ä¿user_idæ˜¯UUIDç±»å‹**

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å±é™©æ“ä½œè­¦å‘Š](./å±é™©æ“ä½œè­¦å‘Š.md) - **å¿…è¯»!** ç¦æ­¢çš„æ“ä½œå’Œæ³¨æ„äº‹é¡¹
- [å…³é”®é…ç½®ä¿¡æ¯](./å…³é”®é…ç½®ä¿¡æ¯.md) - æ•°æ®åº“è¿æ¥å’Œé…ç½®
- [éƒ¨ç½²æŒ‡å—](./éƒ¨ç½²æŒ‡å—.md) - æ•°æ®åº“è¿ç§»å’Œéƒ¨ç½²æµç¨‹

---

[â† è¿”å›README](./README.md)

---

**æœ€åæ›´æ–°**: 2025-11-12
**ç»´æŠ¤è€…**: å°ç‰›é©¬

