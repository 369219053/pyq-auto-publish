# 脚本1: 输入链接自动发布

[← 返回README](./README.md)

---

## 🎯 功能概述

一键完成"公众号文章采集 → AI改写 → 发布到朋友圈"的全流程自动化。用户只需输入公众号文章链接,系统自动完成所有步骤。

---

## 🏗️ 技术架构

```
用户输入URL
    ↓
提取文章内容(COZE工作流)
    ↓
AI智能改写(COZE Bot)
    ↓
创建发布任务(Supabase)
    ↓
Puppeteer自动发布(堆雪球)
```

---

## 📁 核心代码文件

### 后端

- **`pyq-backend/src/automation/automation.service.ts`**
  - `script1_LinkAutoPublish()` - 主流程函数
  - `script1_LinkAutoPublishStream()` - SSE流式输出版本

- **`pyq-backend/src/automation/automation.controller.ts`**
  - `POST /api/automation/script1/link-auto-publish` - HTTP接口
  - `GET /api/automation/script1/link-auto-publish-stream` - SSE接口

- **`pyq-backend/src/collection/collection.service.ts`**
  - `extractArticle()` - 文章提取逻辑

- **`pyq-backend/src/coze/coze.service.ts`**
  - `rewriteContent()` - AI改写逻辑

- **`pyq-backend/src/publish/publish.service.ts`**
  - `createPublishTask()` - 创建发布任务

### 前端

- **`pyq-frontend-vben/apps/web-antd/src/views/scripts/script1.vue`**
  - 用户界面和交互逻辑

---

## 🔌 API接口

### 1. HTTP接口 (推荐)

```typescript
POST /api/automation/script1/link-auto-publish
Content-Type: application/json

{
  "url": "公众号文章链接",
  "userId": "用户UUID",
  "isImmediate": true,              // 是否立即发布
  "publishTime": "2025-11-08 10:00", // 定时发布时间
  "contentType": "text",             // 内容类型: text/image
  "tempTaskId": "temp_123456",       // 前端临时任务ID
  "selectedAccounts": ["微信1"],     // 选择的微小号
  "selectedTags": ["标签1"],         // 选择的标签
  "useLocation": false,              // 是否显示定位
  "comments": ["评论1"],             // 追评论
  "randomContent": "随机内容"        // 随机补充内容
}

// 返回
{
  "success": true,
  "taskId": "script1_1699999999999",
  "message": "任务创建成功"
}
```

### 2. SSE流式接口

```typescript
GET /api/automation/script1/link-auto-publish-stream?url=xxx&userId=xxx

// 实时返回进度
data: {"step":0,"message":"🚀 开始执行自动发布流程...","type":"info"}
data: {"step":1,"message":"📥 正在提取文章内容...","type":"info"}
data: {"step":2,"message":"🤖 正在AI改写文案...","type":"info"}
data: {"step":3,"message":"📝 正在创建发布任务...","type":"info"}
data: {"step":4,"message":"✅ 任务创建成功!","type":"success"}
```

---

## 📊 数据流程

### 步骤1: 文章提取 (collection.service.ts)

- 调用COZE工作流 `7564955686342918154`
- 提取标题、作者、内容、图片URL
- 下载图片并上传到Supabase Storage

### 步骤2: AI改写 (coze.service.ts)

- 调用COZE Bot API
- 生成3个版本文案
- 轮询获取结果(处理in_progress状态)

### 步骤3: 创建任务 (publish.service.ts)

- 插入`publish_tasks`表
- 设置发布时间和状态
- 关联用户和文章

### 步骤4: 自动发布 (scheduler.service.ts)

- 每分钟检查待发布任务
- 调用Puppeteer自动化发布
- 更新任务状态

---

## 🔑 关键技术点

### 1. 临时任务ID机制

- 前端生成`tempTaskId`,立即显示在任务列表
- 后端创建真实任务后,前端替换临时ID
- 解决任务创建延迟导致的用户体验问题

### 2. COZE工作流集成

- 使用第三方插件"微信公众号超级无敌插件"
- 插件ID: `7489062831753691176`
- API: `extract_gzh_article_data`
- **风险**: 依赖第三方插件,可能失效
- **备用方案**: 极致了API (0.06元/次)

### 3. 图片处理

- 下载公众号图片到本地
- 上传到Supabase Storage
- 发布时转Base64上传到堆雪球

### 4. 错误处理

- 每个步骤都有try-catch
- 失败时返回详细错误信息
- 支持重试机制

---

## ⚠️ 已知问题

### 1. COZE插件依赖风险

- 当前依赖第三方开发者的COZE插件
- 如果插件下架,功能将失效
- 建议切换到极致了API或自建Puppeteer爬虫

### 2. 图片下载超时

- 大图片(>10MB)可能下载超时
- 已通过Storage解决,但仍需优化

### 3. AI改写耗时

- COZE Bot响应时间不稳定(5-30秒)
- 已实现轮询机制,但用户体验仍需优化

---

## 📋 待优化项

- [ ] 添加文章去重检测
- [ ] 支持批量导入链接
- [ ] 优化AI改写速度
- [ ] 添加发布结果验证
- [ ] 支持自定义改写模板

---

## 🔗 相关文档

- [脚本2: 微信好友触达](./脚本2-微信好友触达.md)
- [脚本3: 定时监控自动发布](./脚本3-定时监控自动发布.md)
- [脚本4: 跟圈自动化](./脚本4-跟圈自动化.md)
- [部署指南](./部署指南.md)
- [常见问题](./常见问题.md)

---

[← 返回README](./README.md)

