# 脚本4: 跟圈自动化

[← 返回README](./README.md)

---

## 🎯 功能概述

自动发布多条相同内容的朋友圈,每次发布新朋友圈前自动删除上一条,最后一条保留不删除。适用于产品推广、活动宣传等需要持续曝光的场景。

---

## 🏗️ 技术架构

```
创建跟圈任务组
    ↓
上传图片到Storage
    ↓
计算每条朋友圈的发布时间
    ↓
定时发布第1条
    ↓
定时发布第2条(删除第1条)
    ↓
定时发布第3条(删除第2条)
    ↓
...
    ↓
发布最后一条(保留不删除)
```

---

## 📁 核心代码文件

### 后端

- **`pyq-backend/src/automation/follow-circle.service.ts`**
  - `createFollowCircleTasksWithLogs()` - 创建任务组
  - `executeFollowCircleTask()` - 执行单个任务
  - `deleteFollowCirclePost()` - 删除朋友圈
  - `publishToMoments()` - 发布朋友圈

- **`pyq-backend/src/automation/automation.controller.ts`**
  - `POST /api/automation/script4/follow-circle` - 创建任务
  - `POST /api/automation/script4/stop` - 停止任务

- **`pyq-backend/src/storage/storage.service.ts`**
  - `uploadFollowCircleImages()` - 上传图片到Storage
  - `downloadImageAsBase64()` - 下载图片为Base64

- **`pyq-backend/src/puppeteer/task-queue.service.ts`**
  - 任务队列管理(优先级调度)

### 前端

- **`pyq-frontend-vben/apps/web-antd/src/views/scripts/script4.vue`**
  - 用户界面和WebSocket连接

---

## 🔌 API接口

### 1. 创建跟圈任务

```typescript
POST /api/automation/script4/follow-circle
Content-Type: application/json

{
  "content": "朋友圈文案内容",
  "images": [
    {
      "data": "base64编码的图片数据",
      "name": "image1.jpg"
    }
  ],
  "followCount": 5,              // 跟圈次数
  "intervalMinutes": 60,         // 间隔时间(分钟)
  "randomDelayMinutes": 10,      // 随机延迟(分钟)
  "delayStartMinutes": 0,        // 延迟启动(分钟)
  "contentType": "text",         // 内容类型
  "userId": "用户UUID",
  "tempTaskGroupId": "temp_123"  // 前端临时任务ID
}

// 返回
{
  "success": true,
  "taskGroupId": "跟圈_1699999999999",
  "message": "跟圈任务创建成功"
}
```

### 2. 停止跟圈任务

```typescript
POST /api/automation/script4/stop
Content-Type: application/json

{
  "taskGroupId": "跟圈_1699999999999"
}
```

### 3. WebSocket实时推送

```typescript
// 连接
ws://localhost:3000/automation/ws/{taskGroupId}

// 接收日志
{
  "event": "log",
  "data": {
    "taskGroupId": "跟圈_1699999999999",
    "log": "📋 任务组ID: 跟圈_1699999999999",
    "timestamp": "2025-11-07T10:00:00.000Z"
  }
}

// 接收完成通知
{
  "event": "complete",
  "data": {
    "taskGroupId": "跟圈_1699999999999",
    "success": true,
    "message": "所有任务执行完成"
  }
}
```

---

## 📊 数据流程

### 步骤1: 创建任务组 (createFollowCircleTasksWithLogs)

- 生成任务组ID: `跟圈_时间戳`
- 生成组编号: `A1234`
- 上传图片到Storage
- 计算每条朋友圈的发布时间
- 插入`follow_circle_tasks`表

### 步骤2: 上传图片 (uploadFollowCircleImages)

- 接收Base64图片数据
- 转换为Buffer
- 上传到`follow-circle-images` bucket
- 路径: `task_时间戳/image_索引.扩展名`
- 返回Storage URL数组

### 步骤3: 定时发布 (executeFollowCircleTask)

- 使用`node-schedule`创建定时任务
- 到达发布时间时触发
- 从Storage下载图片为Base64
- 调用Puppeteer发布到堆雪球
- 更新任务状态为"已完成"

### 步骤4: 删除上一条 (deleteFollowCirclePost)

- 查询上一条任务的`post_id`
- 登录堆雪球
- 找到对应朋友圈
- 点击删除按钮
- 确认删除

### 步骤5: 自动清理 (scheduler.service.ts)

- 每天凌晨3点执行
- 查询7天前完成的任务
- 删除Storage中的图片
- 删除数据库记录

---

## 🔑 关键技术点

### 1. 时间计算

```typescript
// 第1条: delayStartMinutes + 0 * intervalMinutes
// 第2条: delayStartMinutes + 1 * intervalMinutes
// 第3条: delayStartMinutes + 2 * intervalMinutes
const baseDelay = delayStartMinutes + (i - 1) * intervalMinutes;
let publishTime = new Date(now.getTime() + baseDelay * 60 * 1000);

// 添加随机延迟(排除0)
if (randomDelayMinutes > 0) {
  let randomDelay = Math.floor(Math.random() * (randomDelayMinutes * 2)) + 1;
  if (randomDelay > randomDelayMinutes) {
    randomDelay = randomDelay - randomDelayMinutes;
  } else {
    randomDelay = randomDelay - randomDelayMinutes - 1;
  }
  publishTime = new Date(publishTime.getTime() + randomDelay * 60 * 1000);
}
```

### 2. 任务队列优先级

```typescript
// Script 4任务优先级最低,允许其他任务插队
await this.taskQueueService.addTask({
  id: taskId,
  type: 'follow-circle',
  priority: 1,  // 最低优先级
  execute: async () => {
    await this.executeFollowCircleTask(task);
  }
});
```

### 3. 图片Storage存储

```typescript
// 上传
const { data, error } = await supabase.storage
  .from('follow-circle-images')
  .upload(`${taskGroupId}/image_${index}.${ext}`, buffer, {
    contentType: `image/${ext}`,
    upsert: true
  });

// 下载
const { data: blob } = await supabase.storage
  .from('follow-circle-images')
  .download(imagePath);

const buffer = Buffer.from(await blob.arrayBuffer());
const base64 = buffer.toString('base64');
```

### 4. 堆雪球自动化

```typescript
// 发布朋友圈
await page.click('button:has-text("发朋友圈")');
await page.fill('textarea', content);
await page.setInputFiles('input[type="file"]', imageFiles);
await page.click('button:has-text("确定")');

// 删除朋友圈
await page.click(`[data-post-id="${postId}"] button:has-text("删除")`);
await page.click('button:has-text("确定")');
```

### 5. 定时任务调度

```typescript
const job = schedule.scheduleJob(publishTime, async () => {
  await this.executeFollowCircleTask(task);
});
this.scheduledJobs.set(taskId, job);
```

---

## ⚠️ 已知问题

### 1. 图片大小限制

- 单张图片最大15MB
- 超过限制会上传失败
- 需要添加压缩功能

### 2. 删除失败无重试

- 删除朋友圈失败不会重试
- 可能导致旧朋友圈残留
- 需要添加重试机制

### 3. 任务取消不完整

- 停止任务只取消未执行的
- 正在执行的任务无法中断
- 需要添加强制中断功能

---

## 📋 待优化项

- [ ] 添加图片压缩功能
- [ ] 删除失败重试机制
- [ ] 支持任务强制中断
- [ ] 添加任务执行报告
- [ ] 支持自定义删除策略
- [ ] 优化Storage容量管理

---

## 🔗 相关文档

- [脚本1: 输入链接自动发布](./脚本1-输入链接自动发布.md)
- [脚本2: 微信好友触达](./脚本2-微信好友触达.md)
- [脚本3: 定时监控自动发布](./脚本3-定时监控自动发布.md)
- [部署指南](./部署指南.md)
- [常见问题](./常见问题.md)

---

[← 返回README](./README.md)

