# 危险操作警告

> **🚨 重要**: 本文档列出了所有禁止或需要谨慎的操作,修改代码前必须阅读!

**最后更新**: 2025-11-10  
**维护者**: 小牛马

---

## 📋 目录

- [绝对禁止的操作](#绝对禁止的操作)
- [需要谨慎的操作](#需要谨慎的操作)
- [修改前的检查清单](#修改前的检查清单)
- [紧急恢复流程](#紧急恢复流程)

---

## ❌ 绝对禁止的操作

### 1. 数据库相关

#### 🚫 禁止修改表结构

**禁止的操作**:
- ❌ 修改字段类型 (尤其是`user_id`字段)
- ❌ 删除字段
- ❌ 删除表
- ❌ 修改主键类型
- ❌ 删除外键约束

**原因**:
- 会导致数据丢失
- 会导致应用程序报错
- 会导致关联表失效
- **已经发生过user_id类型错误导致系统崩溃的事故**

**如果必须修改**:
1. ✅ 先查看[数据库结构文档](./数据库结构文档.md)
2. ✅ 创建迁移文件 (`migrations/`)
3. ✅ 在本地数据库测试
4. ✅ 备份生产数据库
5. ✅ 准备回滚方案
6. ✅ 在非高峰期执行
7. ✅ 执行后立即验证所有功能

---

#### 🚫 禁止删除迁移文件

**禁止的操作**:
- ❌ 删除`migrations/`目录下的任何文件
- ❌ 修改已执行的迁移文件
- ❌ 重命名迁移文件

**原因**:
- 迁移文件是数据库变更的历史记录
- 删除会导致无法追溯变更
- 删除会导致无法回滚

**正确做法**:
- ✅ 只能添加新的迁移文件
- ✅ 如果需要回滚,创建新的回滚迁移文件

---

#### 🚫 禁止直接在生产数据库执行SQL

**禁止的操作**:
- ❌ 直接在Supabase后台执行SQL
- ❌ 直接在服务器上执行SQL
- ❌ 使用psql直接修改数据

**原因**:
- 没有版本控制
- 无法回滚
- 容易出错

**正确做法**:
- ✅ 创建迁移文件
- ✅ 在本地测试
- ✅ 通过代码执行迁移

---

### 2. 配置文件相关

#### 🚫 禁止修改核心配置

**禁止的操作**:
- ❌ 修改`.env`文件中的数据库连接
- ❌ 修改Supabase URL和Key
- ❌ 修改PM2配置文件
- ❌ 修改Nginx配置文件
- ❌ 删除环境变量

**原因**:
- 会导致服务无法启动
- 会导致数据库连接失败
- 会导致前端无法访问

**如果必须修改**:
1. ✅ 先备份配置文件
2. ✅ 在本地测试
3. ✅ 准备回滚方案
4. ✅ 在非高峰期执行

---

### 3. 代码相关

#### 🚫 禁止直接在服务器上修改代码

**禁止的操作**:
- ❌ 直接在服务器上编辑代码
- ❌ 直接在服务器上删除文件
- ❌ 直接在服务器上修改配置

**原因**:
- 没有版本控制
- 无法回滚
- 容易出错

**正确做法**:
- ✅ 在本地修改代码
- ✅ 在本地测试
- ✅ 提交到Git
- ✅ 部署到服务器

---

#### 🚫 禁止修改核心Entity定义

**禁止的操作**:
- ❌ 修改Entity的字段类型
- ❌ 删除Entity的字段
- ❌ 修改Entity的关联关系

**原因**:
- 会导致数据库结构不一致
- 会导致应用程序报错
- 需要同步修改数据库

**如果必须修改**:
1. ✅ 先查看[数据库结构文档](./数据库结构文档.md)
2. ✅ 创建迁移文件
3. ✅ 同步修改Entity和数据库

---

### 4. 部署相关

#### 🚫 禁止在高峰期部署

**禁止的操作**:
- ❌ 在工作时间部署
- ❌ 在没有测试的情况下部署
- ❌ 在没有备份的情况下部署

**原因**:
- 影响用户使用
- 出问题难以恢复
- 没有回滚方案

**正确做法**:
- ✅ 在非高峰期部署(凌晨或周末)
- ✅ 部署前充分测试
- ✅ 部署前备份代码和数据库
- ✅ 准备回滚方案

---

## ⚠️ 需要谨慎的操作

### 1. 数据库操作

#### ⚠️ 修改数据

**需要谨慎**:
- 批量更新数据
- 批量删除数据
- 修改关键字段

**注意事项**:
1. ✅ 先备份数据
2. ✅ 使用事务
3. ✅ 先在测试环境验证
4. ✅ 小批量执行
5. ✅ 验证结果

---

#### ⚠️ 添加索引

**需要谨慎**:
- 在大表上添加索引
- 添加唯一索引

**注意事项**:
1. ✅ 在非高峰期执行
2. ✅ 使用`CONCURRENTLY`选项
3. ✅ 监控执行时间
4. ✅ 准备回滚方案

---

### 2. 代码修改

#### ⚠️ 修改核心业务逻辑

**需要谨慎**:
- 修改发布逻辑
- 修改跟圈逻辑
- 修改Puppeteer脚本

**注意事项**:
1. ✅ 充分理解现有逻辑
2. ✅ 查看相关文档
3. ✅ 在本地充分测试
4. ✅ 准备回滚方案

---

#### ⚠️ 修改API接口

**需要谨慎**:
- 修改接口参数
- 修改返回格式
- 删除接口

**注意事项**:
1. ✅ 检查前端是否使用
2. ✅ 保持向后兼容
3. ✅ 更新API文档
4. ✅ 通知相关人员

---

### 3. 依赖管理

#### ⚠️ 升级依赖

**需要谨慎**:
- 升级主要依赖(NestJS, Vue等)
- 升级数据库驱动
- 升级Puppeteer

**注意事项**:
1. ✅ 查看升级日志
2. ✅ 检查破坏性变更
3. ✅ 在本地充分测试
4. ✅ 准备回滚方案

---

## ✅ 修改前的检查清单

### 第一步: 文档检查

- [ ] 是否查看了[数据库结构文档](./数据库结构文档.md)?
- [ ] 是否查看了[危险操作警告](./危险操作警告.md)(本文档)?
- [ ] 是否查看了相关功能文档?
- [ ] 是否理解了系统架构?
- [ ] 是否理解了业务逻辑?

### 第二步: 影响范围评估

- [ ] 是否需要修改数据库?
- [ ] 是否需要修改配置?
- [ ] 是否需要修改核心代码?
- [ ] 是否会影响现有功能?
- [ ] 是否会影响用户使用?

### 第三步: 准备工作

- [ ] 是否已经备份代码?
- [ ] 是否已经备份数据库?
- [ ] 是否已经备份配置文件?
- [ ] 是否准备了回滚方案?
- [ ] 是否在本地测试通过?

### 第四步: 执行

- [ ] 是否在非高峰期执行?
- [ ] 是否有人监控执行过程?
- [ ] 是否记录了执行日志?
- [ ] 是否验证了执行结果?

### 第五步: 验证

- [ ] 是否测试了所有相关功能?
- [ ] 是否检查了数据库结构?
- [ ] 是否检查了日志?
- [ ] 是否通知了相关人员?

---

## 🚨 紧急恢复流程

### 场景1: 代码被破坏

**立即执行**:
```bash
# 1. 查看Git历史
git log --oneline -20

# 2. 回退到正确版本
git reset --hard <commit-hash>

# 3. 强制推送到GitHub
git push origin main --force

# 4. 部署到服务器
rsync -avz --exclude='node_modules' pyq-backend/ root@124.223.35.102:/www/wwwroot/pyq-backend/
ssh root@124.223.35.102 "cd /www/wwwroot/pyq-backend && npm run build && pm2 restart pyq-backend"
```

**详细步骤**: 查看[Git版本管理指南](./Git版本管理指南.md#紧急恢复流程)

---

### 场景2: 数据库被破坏

**立即执行**:
1. **停止服务**
   ```bash
   ssh root@124.223.35.102
   pm2 stop pyq-backend
   ```

2. **从Supabase备份恢复**
   - 登录Supabase后台
   - 进入Database → Backups
   - 选择最近的备份
   - 点击Restore

3. **重启服务**
   ```bash
   pm2 restart pyq-backend
   ```

4. **验证功能**
   - 测试登录
   - 测试公众号监控
   - 测试发布功能

---

### 场景3: 配置文件被破坏

**立即执行**:
1. **从备份恢复配置**
   ```bash
   # 恢复.env文件
   cp .env.backup .env
   
   # 或从服务器拉取正确的配置
   scp root@124.223.35.102:/www/wwwroot/pyq-backend/.env ./
   ```

2. **重启服务**
   ```bash
   pm2 restart pyq-backend
   ```

---

## 📞 紧急联系

如果遇到无法解决的问题:

1. **立即停止服务**
   ```bash
   pm2 stop pyq-backend
   ```

2. **查看日志**
   ```bash
   pm2 logs pyq-backend --lines 100
   ```

3. **联系小牛马**
   - 提供具体的错误信息
   - 提供操作步骤
   - 提供日志内容

---

## 📚 相关文档

- [数据库结构文档](./数据库结构文档.md) - 完整的数据库结构说明
- [Git版本管理指南](./Git版本管理指南.md) - Git操作和版本回退
- [部署指南](./部署指南.md) - 部署流程和注意事项
- [常见问题](./常见问题.md) - 常见问题和解决方案

---

**最后更新**: 2025-11-10  
**维护者**: 小牛马

