# è„šæœ¬3: å®šæ—¶ç›‘æ§è‡ªåŠ¨å‘å¸ƒ

[â† è¿”å›README](./README.md)

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å®šæ—¶æ£€æŸ¥è®¢é˜…çš„å…¬ä¼—å·æ˜¯å¦æœ‰æ–°æ–‡ç« ,å¦‚æœæœ‰æ–°æ–‡ç« åˆ™è‡ªåŠ¨æå–ã€æ”¹å†™ã€å‘å¸ƒåˆ°æœ‹å‹åœˆã€‚é€‚ç”¨äºæŒç»­è¿è¥åœºæ™¯,æ— éœ€äººå·¥å¹²é¢„ã€‚

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
å®šæ—¶æ£€æŸ¥æ–°æ–‡ç« (æ¯å°æ—¶)
    â†“
ç­›é€‰æœ€è¿‘1å°æ—¶å†…çš„æ–‡ç« 
    â†“
è‡ªåŠ¨æå–æ–‡ç« å†…å®¹
    â†“
è‡ªåŠ¨AIæ”¹å†™(å¯é€‰)
    â†“
è‡ªåŠ¨åˆ›å»ºå‘å¸ƒä»»åŠ¡
    â†“
å»¶è¿Ÿå‘å¸ƒ(å¯é€‰)
```

---

## ğŸ“ æ ¸å¿ƒä»£ç æ–‡ä»¶

### åç«¯

- **`pyq-backend/src/automation/automation.service.ts`**
  - `script3_MonitorAutoPublish()` - ä¸»æµç¨‹å‡½æ•°

- **`pyq-backend/src/automation/automation.controller.ts`**
  - `POST /api/automation/script3/monitor-auto-publish` - HTTPæ¥å£

- **`pyq-backend/src/wechat-monitor/wechat-monitor.service.ts`**
  - `getArticles()` - è·å–æ–‡ç« åˆ—è¡¨

- **`pyq-backend/src/scheduler/scheduler.service.ts`**
  - å®šæ—¶ä»»åŠ¡è°ƒåº¦(å¯é€‰é›†æˆ)

### å‰ç«¯

- **`pyq-frontend-vben/apps/web-antd/src/views/scripts/script3.vue`**
  - ç”¨æˆ·ç•Œé¢å’Œé…ç½®

---

## ğŸ”Œ APIæ¥å£

```typescript
POST /api/automation/script3/monitor-auto-publish
Content-Type: application/json

{
  "userId": "ç”¨æˆ·UUID",
  "accountIds": ["å…¬ä¼—å·ID1", "å…¬ä¼—å·ID2"],  // ç›‘æ§çš„å…¬ä¼—å·åˆ—è¡¨
  "autoRewrite": true,                      // æ˜¯å¦è‡ªåŠ¨è½¬å†™
  "autoPublish": true,                      // æ˜¯å¦è‡ªåŠ¨å‘å¸ƒ
  "publishDelay": 30,                       // å‘å¸ƒå»¶è¿Ÿ(åˆ†é’Ÿ)
  "contentType": "text",                    // å†…å®¹ç±»å‹
  "selectedAccounts": ["å¾®ä¿¡1"],            // é€‰æ‹©çš„å¾®å°å·
  "selectedTags": ["æ ‡ç­¾1"],                // é€‰æ‹©çš„æ ‡ç­¾
  "useLocation": false,                     // æ˜¯å¦æ˜¾ç¤ºå®šä½
  "comments": ["è¯„è®º1"],                    // è¿½è¯„è®º
  "randomContent": "éšæœºå†…å®¹"               // éšæœºè¡¥å……å†…å®¹
}

// è¿”å›
{
  "success": true,
  "processedCount": 3,
  "message": "å¤„ç†äº†3ç¯‡æ–°æ–‡ç« "
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹

### æ­¥éª¤1: è·å–æ–°æ–‡ç« 

- æŸ¥è¯¢`wechat_articles`è¡¨
- ç­›é€‰æœ€è¿‘1å°æ—¶å†…çš„æ–‡ç« 
- ç­›é€‰æŒ‡å®šå…¬ä¼—å·(å¦‚æœæœ‰)
- æ’é™¤å·²å¤„ç†çš„æ–‡ç« 

### æ­¥éª¤2: æå–æ–‡ç« å†…å®¹

- è°ƒç”¨`collection.service.extractArticle()`
- æå–æ ‡é¢˜ã€ä½œè€…ã€å†…å®¹ã€å›¾ç‰‡
- ä¸‹è½½å›¾ç‰‡åˆ°Storage

### æ­¥éª¤3: AIæ”¹å†™ (å¯é€‰)

- å¦‚æœ`autoRewrite = true`
- è°ƒç”¨`coze.service.rewriteContent()`
- ç”Ÿæˆ3ä¸ªç‰ˆæœ¬æ–‡æ¡ˆ
- é€‰æ‹©ç¬¬ä¸€ä¸ªç‰ˆæœ¬

### æ­¥éª¤4: åˆ›å»ºå‘å¸ƒä»»åŠ¡ (å¯é€‰)

- å¦‚æœ`autoPublish = true`
- è®¡ç®—å‘å¸ƒæ—¶é—´(å½“å‰æ—¶é—´ + publishDelay)
- è°ƒç”¨`publish.service.createPublishTask()`
- æ’å…¥`publish_tasks`è¡¨

### æ­¥éª¤5: æ›´æ–°æ–‡ç« çŠ¶æ€

- æ ‡è®°æ–‡ç« ä¸º"å·²å¤„ç†"
- é¿å…é‡å¤å¤„ç†

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. æ—¶é—´ç­›é€‰

```typescript
const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
const { data: articles } = await supabase
  .from('wechat_articles')
  .select('*')
  .gte('published_at', oneHourAgo.toISOString())
  .order('published_at', { ascending: false });
```

### 2. å»é‡å¤„ç†

```typescript
// æ–¹æ¡ˆ1: æ£€æŸ¥æ˜¯å¦å·²åˆ›å»ºå‘å¸ƒä»»åŠ¡
const { data: existingTask } = await supabase
  .from('publish_tasks')
  .select('id')
  .eq('article_id', article.id)
  .single();

if (existingTask) {
  continue; // è·³è¿‡å·²å¤„ç†çš„æ–‡ç« 
}
```

### 3. å»¶è¿Ÿå‘å¸ƒ

```typescript
const publishTime = new Date(Date.now() + publishDelay * 60 * 1000);
```

### 4. æ‰¹é‡å¤„ç†

```typescript
for (const article of articles) {
  try {
    await this.processArticle(article, options);
  } catch (error) {
    this.logger.error(`å¤„ç†æ–‡ç« å¤±è´¥: ${article.title}`, error);
    // ç»§ç»­å¤„ç†ä¸‹ä¸€ç¯‡,ä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
  }
}
```

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. æ— å®šæ—¶è°ƒåº¦

- å½“å‰éœ€è¦æ‰‹åŠ¨è§¦å‘
- éœ€è¦é›†æˆåˆ°`scheduler.service.ts`
- æ·»åŠ cronè¡¨è¾¾å¼é…ç½®

### 2. æ— é‡å¤æ£€æµ‹

- å¯èƒ½é‡å¤å¤„ç†åŒä¸€ç¯‡æ–‡ç« 
- éœ€è¦æ·»åŠ æ›´ä¸¥æ ¼çš„å»é‡é€»è¾‘
- è®°å½•å¤„ç†å†å²

### 3. æ— é”™è¯¯æ¢å¤

- å¤„ç†å¤±è´¥çš„æ–‡ç« ä¸ä¼šé‡è¯•
- éœ€è¦æ·»åŠ é‡è¯•æœºåˆ¶
- è®°å½•å¤±è´¥åŸå› 

---

## ğŸ“‹ å¾…ä¼˜åŒ–é¡¹

- [ ] é›†æˆå®šæ—¶è°ƒåº¦(cron)
- [ ] æ·»åŠ æ–‡ç« å»é‡æ£€æµ‹
- [ ] æ”¯æŒè‡ªå®šä¹‰ç›‘æ§é—´éš”
- [ ] æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶
- [ ] æ”¯æŒç›‘æ§è§„åˆ™é…ç½®
- [ ] æ·»åŠ ç›‘æ§æŠ¥å‘Šç”Ÿæˆ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [è„šæœ¬1: è¾“å…¥é“¾æ¥è‡ªåŠ¨å‘å¸ƒ](./è„šæœ¬1-è¾“å…¥é“¾æ¥è‡ªåŠ¨å‘å¸ƒ.md)
- [è„šæœ¬2: å¾®ä¿¡å¥½å‹è§¦è¾¾](./è„šæœ¬2-å¾®ä¿¡å¥½å‹è§¦è¾¾.md)
- [è„šæœ¬4: è·Ÿåœˆè‡ªåŠ¨åŒ–](./è„šæœ¬4-è·Ÿåœˆè‡ªåŠ¨åŒ–.md)
- [éƒ¨ç½²æŒ‡å—](./éƒ¨ç½²æŒ‡å—.md)
- [å¸¸è§é—®é¢˜](./å¸¸è§é—®é¢˜.md)

---

[â† è¿”å›README](./README.md)

