# 朋友圈自动发布系统

<div align="center">

**专为私域运营打造的智能助手**

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Node](https://img.shields.io/badge/node-20.19.5-green.svg)](https://nodejs.org/)
[![Vue](https://img.shields.io/badge/vue-3.x-brightgreen.svg)](https://vuejs.org/)

</div>

---

## 📖 项目简介

朋友圈自动发布系统是一个专为私域运营打造的智能助手,集成了公众号监控、AI智能改写、自动发布、微信好友触达、跟圈自动化等功能,帮助运营人员提高工作效率,实现自动化运营。

### 核心价值

- 🚀 **提高效率** - 自动化完成重复性工作,节省80%时间
- 🤖 **AI赋能** - 智能改写文案,保持内容新鲜度
- 📊 **数据驱动** - 实时监控,精准触达目标用户
- 🔄 **持续运营** - 7x24小时自动运行,无需人工干预

---

## 🤖 新AI助手必读

> **⚠️ 重要**: 修改任何代码前,必须先阅读本章节!

### 核心原则

1. **先理解,后修改** - 不要看到需求就直接改代码
2. **主动查找,全面理解** - 使用codebase-retrieval查找所有相关代码和文档
3. **不确定就询问** - 不要盲目假设,主动询问刀仔老板

---

### 标准工作流程 (5步法)

#### 第1步: 理解需求
- 仔细阅读刀仔老板的需求
- 确认涉及哪些功能模块
- 不清楚就主动询问

#### 第2步: 查找相关文档
- 查看下方的[功能模块与文档映射表](#功能模块与文档映射)
- 找到所有相关文档并阅读
- **必读**: [危险操作警告](./危险操作警告.md)
- **必读**: [⚙️ 本地测试与部署流程](#️-本地测试与部署流程) - **所有修改都必须遵循正确的测试流程!**
- **如果涉及前端修改**: 必须完成**生产构建测试** + 服务器部署
- **如果涉及Puppeteer**: [本地测试指南](./本地测试指南.md) - **强烈推荐!** 本地测试后再部署
- **如果涉及数据库**: [数据库文档](./数据库结构文档.md)
- **如果涉及部署**: [部署与配置指南](./部署与配置指南.md)
- **如果遇到问题**: [常见问题与解决方案](./常见问题与解决方案.md)

#### 第3步: 使用codebase-retrieval查找代码
```
示例查询:
"公众号监控功能的代码在哪里?"
"rewrite_history表在哪些地方被使用?"
"Puppeteer登录堆雪球的代码在哪里?"
```

#### 第4步: 制定修改方案
- 列出需要修改的文件清单
- 评估影响范围
- 制定测试计划和回滚方案

#### 第5步: 执行修改
- 按照[修改前检查清单](#修改前检查清单)检查
- **严格遵循[测试流程](#️-本地测试与部署流程)**:
  - 前端修改: **生产构建测试** → 部署
  - 后端修改: 本地测试 → 部署
- 更新相关文档

---

### ⚙️ 本地测试与部署流程

> **⚠️ 重要**: 本地测试环境和服务器生产环境必须保持一致!

#### 🚦 AI助手必读决策指南

**当刀仔老板说"启动本地服务器"、"测试功能"、"看看效果"时:**

```
✅ 永远使用生产构建测试流程
❌ 不要使用开发模式 (pnpm dev:antd)
❌ 不要启动端口5555的服务
✅ 只启动端口4173的生产预览服务
```

**原因**:
- 🔴 开发模式(dev)与生产环境表现不同,可能有bug
- 🔴 刀仔老板不需要热更新,只需要验证功能
- ✅ 生产构建测试 = 真实环境 = 可靠

---

#### 环境信息

**本地测试环境**:
- Node版本: v22.18.0
- 包管理器: pnpm 10.20.0
- 运行模式: 生产构建预览 (`pnpm build + pnpm vite preview`)
- 访问地址: http://localhost:4173

**服务器生产环境**:
- Node版本: v20.19.5
- 包管理器: npm
- 运行模式: 生产构建 (`pnpm build`)
- 访问地址: https://autochat.lfdhk.com

---

#### 前端测试流程 (2步法)

**AI助手修改代码后,或刀仔老板需要测试功能时:**

##### 步骤1: 生产构建测试 ⭐⭐⭐
```bash
cd 朋友圈自动发布系统/pyq-frontend-vben

# 构建生产版本
pnpm build:antd

# 预览生产构建
cd apps/web-antd
pnpm vite preview
```
- 访问 http://localhost:4173
- **完整测试所有功能**
- **确保页面切换、数据加载、交互都正常**
- **这是真实的生产环境**

##### 步骤2: 部署到服务器
```bash
# 只有生产构建测试通过后才能部署
./deploy.sh
```
- 访问 https://autochat.lfdhk.com
- 最终验证

**⚠️ 重要**:
- ✅ 生产构建测试通过 → 可以部署
- ❌ 生产构建测试有问题 → 绝对不能部署

---

#### 后端测试流程

**Puppeteer相关修改**:
- 必须先在本地测试 (有头模式)
- 详见: [本地测试指南](./本地测试指南.md)

**API接口修改**:
- 本地启动后端服务测试
- 使用Postman或前端页面测试
- 确认无误后再部署

---

### 功能模块与文档映射

| 功能模块 | 核心文档 | 数据库表 | 代码位置 |
|---------|---------|---------|---------|
| **公众号监控** | [脚本1](./脚本1-输入链接自动发布.md), [脚本3](./脚本3-定时监控自动发布.md), [we-mp-rss集成](./we-mp-rss集成指南.md) | wechat_articles, monitor_config | pyq-backend/src/wechat-monitor/ |
| **AI转写** | [脚本1](./脚本1-输入链接自动发布.md), [we-mp-rss集成](./we-mp-rss集成指南.md) | rewrite_history | pyq-backend/src/coze/ |
| **朋友圈发布** | [脚本1](./脚本1-输入链接自动发布.md), [堆雪球自动化](./堆雪球自动化操作指南.md) | publish_tasks | pyq-backend/src/publish/ |
| **跟圈功能** | [脚本4](./脚本4-跟圈自动化.md), [堆雪球自动化](./堆雪球自动化操作指南.md) | follow_circle_tasks, delete_circle_tasks | pyq-backend/src/automation/ |
| **微信好友触达** | [脚本2](./脚本2-微信好友触达.md) | duixueqiu_video_materials, duixueqiu_link_materials | pyq-backend/src/automation/ |
| **堆雪球账号** | [堆雪球自动化](./堆雪球自动化操作指南.md) | duixueqiu_accounts | pyq-backend/src/duixueqiu-accounts/ |

**使用方法**:
1. 找到要修改的功能模块
2. 阅读对应的所有核心文档
3. 使用codebase-retrieval查找代码位置
4. 查看[数据库文档](./数据库结构文档.md)(如果涉及数据库)

---

### 修改前检查清单

**文档检查**:
- [ ] 是否阅读了[危险操作警告](./危险操作警告.md)?
- [ ] 是否阅读了所有相关功能的文档?
- [ ] 是否理解了修改的影响范围?

**代码检查**:
- [ ] 是否使用codebase-retrieval查找了相关代码?
- [ ] 是否理解了现有代码的实现方式?

**数据库检查** (如果涉及数据库):
- [ ] 是否阅读了[数据库结构文档](./数据库结构文档.md)?
- [ ] 是否确认了user_id字段类型(必须是UUID)?
- [ ] 是否创建了迁移文件?

**测试流程检查** (⭐⭐⭐ 重要):
- [ ] 是否阅读了[本地测试与部署流程](#️-本地测试与部署流程)?
- [ ] **前端修改**: 是否完成了**生产构建测试** (pnpm build + pnpm vite preview)?
- [ ] **后端修改**: 是否在本地测试了Puppeteer功能(有头模式)?
- [ ] 是否确认生产构建版本功能正常?
- [ ] 是否使用端口4173而不是5555?

**安全检查**:
- [ ] 是否已经备份代码?
- [ ] 是否准备了回滚方案?
- [ ] 是否在本地充分测试?

---

### 不确定时的处理

**必须询问的情况**:
- 不确定某个功能的实现方式
- 不确定修改会影响哪些功能
- 不确定是否需要修改数据库
- 发现文档与代码不一致

**如何询问**:
```
"刀仔老板,我发现XX功能有两种可能的实现方式:
1. 方式A: ...优点...缺点...
2. 方式B: ...优点...缺点...
您希望使用哪种方式?"
```

---

### 绝对禁止的操作

❌ **禁止修改数据库表结构** (尤其是user_id字段类型)
❌ **禁止删除迁移文件**
❌ **禁止直接在生产数据库执行SQL**
❌ **禁止直接在服务器上修改代码**

**详细说明**: [危险操作警告](./危险操作警告.md)

---

## ✨ 核心功能

### 1. 公众号监控
- 实时监控订阅的公众号新文章
- 自动导入历史文章
- 支持批量订阅管理

### 2. AI智能改写
- 一键改写公众号文章
- 生成3个版本供选择
- 支持自定义改写风格

### 3. 自动发布
- 定时发布到朋友圈
- 支持多账号管理
- 图片自动处理和上传

### 4. 微信好友触达
- 批量发送消息给所有好友
- 多账号轮询发送
- 智能间隔和时间控制

### 5. 跟圈自动化
- 自动发布多条朋友圈
- 定时删除旧朋友圈
- 保持持续曝光

---

## 🛠️ 技术栈

### 前端
- **框架**: Vue 3 + TypeScript + Vite
- **UI组件**: Ant Design Vue 4.2.6
- **样式**: Tailwind CSS
- **模板**: Vben Admin 5.5.9

### 后端
- **框架**: NestJS 10.0+ + TypeScript 5.0+
- **数据库**: PostgreSQL 15+ (Supabase托管)
- **认证**: JWT + Passport
- **存储**: Supabase Storage (1GB免费)

### 自动化
- **浏览器**: Puppeteer 21.0+
- **采集**: we-mp-rss (Docker)
- **AI**: Coze API v3
- **集成**: 堆雪球系统

**详细说明**: [技术栈说明.md](./技术栈说明.md) *(待创建)*

---

## 🚀 快速开始

### 环境要求

**本地测试环境**:
- Node.js 22.18.0+ (推荐使用最新LTS版本)
- pnpm 10.20.0+ (包管理器)
- Docker (用于we-mp-rss)
- Supabase账号 (免费)

**服务器生产环境**:
- Node.js 20.19.5+
- npm (包管理器)
- PM2 (进程管理)
- Nginx (反向代理)

---

### 🎯 启动本地服务 (AI助手必读!)

> **⚠️ 重要**: 永远使用生产构建测试,不要使用开发模式!

#### 完整启动流程

```bash
# 1. 克隆项目
git clone [项目地址]
cd 朋友圈自动发布系统

# 2. 配置环境变量
cp pyq-backend/.env.example pyq-backend/.env
# 编辑.env文件,填入Supabase和COZE API配置

# 3. 安装依赖
cd pyq-backend
npm install

cd ../pyq-frontend-vben
pnpm install

# 4. 启动后端服务
cd ../pyq-backend
npm run start:dev
# 后端运行在: http://localhost:3000

# 5. 构建并启动前端 (生产构建测试)
cd ../pyq-frontend-vben
pnpm build:antd

cd apps/web-antd
pnpm vite preview
# 前端运行在: http://localhost:4173
```

#### 🚨 AI助手注意事项

**当刀仔老板说"启动本地服务器"、"测试功能"时:**
- ✅ 执行上述完整流程
- ✅ 使用端口4173 (生产构建预览)
- ❌ 不要使用 `pnpm dev:antd`
- ❌ 不要启动端口5555的服务

**访问地址**:
- 本地测试: http://localhost:4173
- 生产环境: https://autochat.lfdhk.com

---

**详细步骤**: [部署与配置指南.md](./部署与配置指南.md)

---

## 📚 详细文档

### ⚠️ 安全和规范文档 (必读!)

- **[⭐⭐⭐ 危险操作警告](./危险操作警告.md)** - **必读!** 禁止的操作和注意事项
- **[⭐⭐⭐ 数据库文档](./数据库结构文档.md)** - 完整的数据库表结构、ER图、Storage配置
- **[⭐⭐⭐ 本地测试与部署流程](#️-本地测试与部署流程)** - **所有修改必读!** 生产构建测试流程、AI助手决策指南

### 🔧 部署和配置文档 (重要!)

- **[⭐⭐⭐ 本地测试指南](./本地测试指南.md)** - **强烈推荐!** 本地开发环境配置、Puppeteer有头模式、本地测试流程、部署流程
- **[⭐⭐ 部署与配置指南](./部署与配置指南.md)** - **必读!** 服务器信息、环境变量、本地开发、生产部署、第三方服务配置
- **[⭐ 常见问题与解决方案](./常见问题与解决方案.md)** - 部署、功能、性能问题解答,重大问题深度分析

### 📝 核心脚本文档

- **[脚本1: 输入链接自动发布](./脚本1-输入链接自动发布.md)** - 一键完成采集→改写→发布全流程
- **[脚本2: 微信好友触达](./脚本2-微信好友触达.md)** - 批量发送消息(文字/视频号/链接),多账号轮询
- **[脚本3: 定时监控自动发布](./脚本3-定时监控自动发布.md)** - 自动检查新文章并发布
- **[脚本4: 跟圈自动化](./脚本4-跟圈自动化.md)** - 自动发布多条朋友圈并删除旧的

### 🛠️ 技术文档

- **[Git版本管理指南](./Git版本管理指南.md)** - **⭐ 重要!** 完整的Git指南(快速上手、提交流程、版本回退、V4.1专题)
- **[堆雪球自动化操作指南](./堆雪球自动化操作指南.md)** - Puppeteer自动化技术要点、关键技术突破
- **[we-mp-rss集成指南](./we-mp-rss集成指南.md)** - 公众号采集服务配置、Webhook集成、AI摘要功能
- **[服务器常用命令](./服务器常用命令.md)** - 运维命令参考

---

## 🔗 重要链接

- **在线演示**: [https://autochat.lfdhk.com](https://autochat.lfdhk.com)
- **后端API**: http://localhost:3000/api (开发环境)
- **we-mp-rss**: http://localhost:8001 (公众号采集服务)
- **堆雪球系统**: https://dxqscrm.duixueqiu.cn/

---

## 📅 更新日志

### V5.5.2 (2025-11-14) 🆕
- ✅ **好友同步功能修复** - 修复微信号切换失败问题,优化滚动加载参数

### V5.5.1 (2025-11-11)
- ✅ **Vue Router keep-alive空白页面彻底修复**
  - 修复`subscription.vue`的`onActivated`钩子缺少错误处理导致的空白页面
  - 添加`async/await`确保异步操作正确执行
  - 添加`try-catch`错误处理,防止异常导致页面崩溃
  - 修复`script2.vue`和`script4.vue`的`onActivated`钩子
  - 确保所有页面切换时数据正确重新加载和WebSocket重连

### V5.5 (2025-11-11)
- ✅ **三种消息类型完整支持**
  - **文字消息**: 纯文本消息,支持`{昵称}`变量个性化
  - **视频号消息**: 发送视频号卡片,从堆雪球素材库同步
  - **链接消息**: 发送公众号文章链接卡片,从堆雪球素材库同步
- ✅ **新增数据库表**
  - `duixueqiu_video_materials`: 视频号素材表(user_id UUID, author_name, content_desc, thumbnail_url)
  - `duixueqiu_link_materials`: 链接素材表(user_id UUID, title, account_name TEXT, thumbnail_url, link_url)
- ✅ **素材库同步功能**
  - Puppeteer自动爬取堆雪球素材库(视频号/链接)
  - 支持分页加载和去重(UNIQUE约束)
  - 前端可视化选择素材(缩略图+标题)
  - 智能间隔控制,避免频繁发送
- ✅ **Vue Router keep-alive初步支持**
  - 添加`onActivated`生命周期钩子处理缓存组件
  - 支持页面切换时数据重新加载

### V5.4 (2025-11-10)
- ✅ **视频号批量发送功能**
  - 自动同步堆雪球视频号素材库
  - 可视化选择视频号素材
  - 批量发送给所有微信好友
  - 支持附加文案和{昵称}变量
  - 智能间隔控制,避免频繁发送
  - 实时进度显示和日志推送

### V5.5 (2025-11-15)
- ✅ **重大文档重构: 移除开发模式,统一使用生产构建测试**
  - 删除所有关于开发模式(pnpm dev:antd)的内容
  - 统一使用生产构建测试流程(pnpm build + pnpm vite preview)
  - 新增"AI助手决策指南",明确禁止使用端口5555
  - 重写"快速开始"章节,只保留生产构建流程
  - 简化测试流程为2步法(生产构建测试→部署)
- ✅ **核心原则确立**
  - 刀仔老板不需要开发模式,只需要生产构建测试
  - AI助手修改代码后直接做生产构建测试
  - 避免"开发模式正常,生产环境出bug"的问题

### V5.4 (2025-11-15)
- ✅ **环境差异与测试流程文档**
  - 新增环境差异与测试流程章节
  - 明确本地测试环境vs服务器生产环境差异
  - 详细说明前端测试流程(3步法)
  - 添加环境版本对比(本地Node v22.18.0, 服务器Node v20.19.5)
  - 强调生产构建测试的重要性
- ✅ **Vue Transition问题分析**
  - 发现Vite开发模式与生产模式表现差异
  - 确认生产构建正常运行
  - 更新常见问题文档Q16

### V5.3.1 (2025-11-10)
- ✅ **微信登录体验优化**
  - 二维码过期自动刷新,无需手动操作
  - 警告卡片增加"刷新二维码"快捷按钮
  - 优化登录状态检测和提示信息
  - 修复扫码后警告卡片不消失的问题

### V5.3 (2025-11-10)
- ✅ **移动端适配优化**
  - 公众号监控页面完美适配手机端
  - 响应式布局:移动端垂直排列,桌面端横向排列
  - 左侧订阅列表移动端占40%高度,桌面端固定320px宽度
  - 标签页和按钮优化,移动端更紧凑
  - 所有页面均支持移动端访问

### V5.2.1 (2025-11-10)
- ✅ **警告卡片显示逻辑优化**
  - 添加计算属性控制警告卡片显示,提高响应性
  - 新增手动关闭按钮(✕),用户可临时关闭警告
  - 移除跳动动画,减少视觉干扰
  - 智能重置关闭状态:登录过期时自动重新显示
  - 添加详细调试日志,便于问题排查

### V5.2 (2025-11-07)
- ✅ **Script 2: 微信好友触达功能开发完成**
  - 批量发送消息给所有微信好友
  - 多账号轮询策略,分散发送压力
  - 智能间隔计算,根据好友数和目标天数自动调整
  - 时间控制机制,只在8:00-22:00发送
  - 消息个性化,支持{昵称}变量
  - 实时进度显示,WebSocket推送日志

### V5.1 (2025-11-06)
- ✅ **公众号监控页面优化**
  - AI摘要自动生成并转HTML显示
  - 文章列表布局优化(每页10条)
  - 弹窗转写按钮移除状态限制
  - COZE工作流集成优化

### V5.0 (2025-11-06)
- ✅ **前端框架升级**
  - 从Vue 3 CDN迁移到Vben Admin企业级框架
  - Vue 3 + TypeScript + Vite + Ant Design Vue 4.2.6
  - 企业级架构,模块化设计
  - 类型安全,开发体验提升
- ✅ **重大Bug修复**
  - 解决前端更新后浏览器加载旧文件问题
  - Nginx配置路径问题修复

### V4.1 (2025-11-03)
- ✅ **Supabase Storage图片存储方案**
  - 解决大图片上传超时问题
  - 图片上传到Storage,数据库只存URL
  - 自动清理机制,每天凌晨3点清理7天前图片

### V4.0 (2025-11-01)
- ✅ **智能任务队列系统**
  - 优先级任务队列,避免浏览器冲突
  - Script 4支持延迟启动和多任务并发

---

## 📞 联系方式

- **项目地址**: [GitHub](https://github.com/your-repo)
- **在线演示**: [https://autochat.lfdhk.com](https://autochat.lfdhk.com)
- **技术支持**: 请提交Issue

---

## 📄 许可证

MIT License

---

<div align="center">

**Made with ❤️ by 刀仔老板团队**

</div>

